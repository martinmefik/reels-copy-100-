<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Telegram Web ‚Äî –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <style>
        /* ==================== CSS-–ü–ï–†–ï–ú–ï–ù–ù–´–ï ==================== */
        :root {
            --hue: 210;
            --saturation: 80%;
            --lightness: 60%;
            --bg-primary: hsl(var(--hue), 20%, 10%);
            --bg-secondary: hsl(var(--hue), 20%, 15%);
            --bg-tertiary: hsl(var(--hue), 20%, 20%);
            --bg-glass: hsla(var(--hue), 20%, 20%, 0.8);
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --accent-blue: hsl(var(--hue), var(--saturation), var(--lightness));
            --accent-green: hsl(140, 70%, 50%);
            --accent-red: hsl(0, 70%, 60%);
            --border-color: hsl(var(--hue), 20%, 25%);
            --message-out: hsl(var(--hue), 60%, 40%);
            --message-in: hsl(var(--hue), 20%, 25%);
            --shadow: 0 8px 30px hsla(var(--hue), 20%, 5%, 0.6);
            --shadow-sm: 0 4px 12px hsla(var(--hue), 20%, 5%, 0.3);
            --unread-badge: var(--accent-blue);
            --gradient-1: linear-gradient(135deg, hsl(var(--hue), 80%, 65%) 0%, hsl(calc(var(--hue) + 30), 80%, 65%) 100%);
            --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --admin-gold: linear-gradient(135deg, #ffd700 0%, #ffb347 100%);
            --tester-bg: #000000;
            --tester-text: #ffffff;
            --toggle-bg: hsl(var(--hue), 20%, 25%);
            --toggle-active: var(--accent-blue);
            --font-size: 14px;
            --message-spacing: 12px;
            --wallpaper: none;
        }

        /* –†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ */
        .font-small { --font-size: 12px; }
        .font-medium { --font-size: 14px; }
        .font-large { --font-size: 16px; }

        /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º */
        .compact-mode { --message-spacing: 6px; }

        /* –û–±–æ–∏ */
        .wallpaper-default { --wallpaper: none; }
        .wallpaper-gradient1 { --wallpaper: radial-gradient(circle at 30% 40%, #ff8a5c, #ff4d4d); }
        .wallpaper-gradient2 { --wallpaper: linear-gradient(135deg, #667eea, #764ba2); }
        .wallpaper-gradient3 { --wallpaper: repeating-linear-gradient(45deg, #3f87a6, #ebf8e1 20px); }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--text-secondary);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-blue);
        }

        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            background: radial-gradient(circle at 20% 30%, var(--bg-secondary), var(--bg-primary));
        }

        /* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å */
        .sidebar {
            width: 350px;
            background: var(--bg-glass);
            backdrop-filter: blur(15px);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
            box-shadow: var(--shadow);
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 20px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--gradient-1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
            box-shadow: var(--shadow-sm);
        }
        .avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px var(--accent-blue);
        }

        .profile-info {
            flex: 1;
            min-width: 0;
        }
        .profile-name {
            font-weight: 600;
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .profile-status {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .online-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: var(--accent-green);
            border-radius: 50%;
            margin-left: 6px;
            box-shadow: 0 0 10px var(--accent-green);
        }
        .dnd-badge {
            background: var(--accent-red);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
        }

        .tabs {
            display: flex;
            padding: 16px 16px 12px;
            gap: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        .tab {
            flex: 1;
            padding: 10px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            backdrop-filter: blur(5px);
        }
        .tab.active {
            background: var(--gradient-1);
            color: white;
            box-shadow: 0 4px 15px var(--accent-blue);
        }

        .search-bar {
            padding: 12px 16px;
            position: relative;
        }
        .search-bar input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 40px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: all 0.2s;
        }
        .search-bar input:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px hsla(var(--hue), 80%, 60%, 0.2);
        }

        .create-chat-btn {
            position: absolute;
            right: 24px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--gradient-1);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
        }
        .create-chat-btn:hover {
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 4px 15px var(--accent-blue);
        }

        .chats-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .chat-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 20px;
            margin-bottom: 4px;
            position: relative;
        }
        .chat-item:hover {
            background: var(--bg-glass);
            transform: translateX(4px);
        }
        .chat-item.active {
            background: linear-gradient(90deg, var(--bg-glass), transparent);
            border-left: 4px solid var(--accent-blue);
        }

        .chat-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--gradient-2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 20px;
            flex-shrink: 0;
            box-shadow: var(--shadow-sm);
        }

        .chat-details {
            flex: 1;
            min-width: 0;
        }
        .chat-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chat-last-message {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
            flex-shrink: 0;
        }
        .chat-time {
            font-size: 11px;
            color: var(--text-secondary);
        }
        .chat-unread {
            background: var(--gradient-1);
            color: white;
            font-size: 11px;
            font-weight: 600;
            min-width: 20px;
            height: 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 6px;
            box-shadow: 0 2px 8px var(--accent-blue);
        }
        .lock-icon {
            font-size: 12px;
            margin-left: 4px;
        }

        /* –û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--wallpaper), var(--bg-primary);
            background-blend-mode: overlay;
            min-width: 0;
        }
        .chat-header {
            padding: 12px 20px;
            background: var(--bg-glass);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--shadow-sm);
        }
        .back-button {
            display: none;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 24px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 50%;
            transition: all 0.2s;
        }
        .back-button:hover {
            background: var(--bg-tertiary);
        }
        .chat-info {
            flex: 1;
            min-width: 0;
        }
        .chat-title {
            font-weight: 600;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chat-title span {
            cursor: pointer;
        }
        .chat-title span:hover {
            text-decoration: underline;
        }
        .chat-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: var(--message-spacing);
            scroll-behavior: smooth;
        }

        .message {
            max-width: 75%;
            display: flex;
            flex-direction: column;
            position: relative;
            opacity: 0;
            transform: translateY(20px);
            animation: messageAppear 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            font-size: var(--font-size);
        }
        @keyframes messageAppear {
            to { opacity: 1; transform: translateY(0); }
        }
        .message.out { align-self: flex-end; }
        .message.in { align-self: flex-start; }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 22px;
            line-height: 1.5;
            word-wrap: break-word;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
        }
        .message.out .message-bubble {
            background: var(--gradient-1);
            border-bottom-right-radius: 4px;
            color: white;
        }
        .message.in .message-bubble {
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 4px;
        }

        .message-sender {
            font-size: 12px;
            font-weight: 600;
            color: var(--accent-blue);
            margin-bottom: 4px;
            margin-left: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
        }
        .message-sender:hover {
            text-decoration: underline;
        }

        .message-time {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 4px;
            margin-left: 12px;
        }

        .message-actions {
            position: absolute;
            top: -30px;
            right: 0;
            display: none;
            gap: 4px;
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            padding: 6px 12px;
            border-radius: 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            z-index: 10;
        }
        .message:hover .message-actions {
            display: flex;
        }
        .message-action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 20px;
            transition: all 0.2s;
        }
        .message-action-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ */
        .message-input-container {
            padding: 16px 20px;
            background: var(--bg-glass);
            backdrop-filter: blur(15px);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        .emoji-toggle-btn, .mic-btn, .send-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .emoji-toggle-btn:hover, .mic-btn:hover, .send-btn:hover {
            background: var(--accent-blue);
            color: white;
            transform: scale(1.1);
            border-color: transparent;
        }
        .mic-btn.recording {
            background: var(--accent-red);
            color: white;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .send-btn {
            background: var(--gradient-1);
            color: white;
            border: none;
        }

        .input-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 0;
        }
        .message-input {
            width: 100%;
            padding: 12px 18px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 30px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            resize: none;
            max-height: 100px;
            min-height: 44px;
            transition: all 0.2s;
        }

        .emoji-picker {
            display: flex;
            gap: 8px;
            padding: 12px;
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            border-radius: 40px;
            border: 1px solid var(--border-color);
            margin-bottom: 8px;
            flex-wrap: wrap;
            justify-content: center;
            max-height: 200px;
            overflow-y: auto;
        }
        .emoji-btn {
            background: none;
            border: none;
            font-size: 26px;
            cursor: pointer;
            padding: 6px;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .emoji-btn:hover {
            transform: scale(1.3);
            background: var(--bg-tertiary);
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        .modal.active {
            display: flex;
            animation: fadeIn 0.2s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-radius: 40px;
            padding: 28px;
            width: 100%;
            max-width: 420px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-content h2 {
            margin-bottom: 20px;
            text-align: center;
            font-size: 24px;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .modal-input, .modal-select {
            width: 100%;
            padding: 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 30px;
            color: var(--text-primary);
            font-size: 16px;
            outline: none;
            margin-bottom: 16px;
            transition: all 0.2s;
        }
        .modal-input:focus, .modal-select:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px hsla(var(--hue), 80%, 60%, 0.1);
        }
        .modal-select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
        }

        .modal-btn {
            background: var(--gradient-1);
            border: none;
            color: white;
            padding: 14px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 8px;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
        }
        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px var(--accent-blue);
        }
        .modal-btn.secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .modal-btn.danger {
            background: var(--gradient-2);
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 28px;
            cursor: pointer;
            float: right;
            padding: 0 8px;
            transition: all 0.2s;
        }
        .close-btn:hover {
            color: var(--text-primary);
        }

        .password-input-container {
            position: relative;
            margin-bottom: 16px;
        }
        .toggle-password {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .remember-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .auth-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }
        .auth-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .auth-tab.active {
            background: var(--gradient-1);
            color: white;
            box-shadow: 0 4px 12px var(--accent-blue);
        }

        .admin-badge {
            background: var(--admin-gold);
            color: #000;
            font-size: 11px;
            padding: 3px 10px;
            border-radius: 16px;
            margin-left: 6px;
            font-weight: bold;
            display: inline-block;
        }
        .tester-badge {
            background: var(--tester-bg);
            color: var(--tester-text);
            font-size: 11px;
            padding: 3px 10px;
            border-radius: 16px;
            margin-left: 6px;
            font-weight: bold;
            display: inline-block;
        }

        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
        }
        .avatar-option {
            font-size: 36px;
            background: var(--bg-tertiary);
            border: 2px solid transparent;
            border-radius: 50%;
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            margin: 0 auto;
        }
        .avatar-option:hover {
            transform: scale(1.1);
            border-color: var(--accent-blue);
            background: var(--bg-secondary);
        }
        .avatar-option.selected {
            border-color: var(--accent-green);
            box-shadow: 0 0 15px var(--accent-green);
        }

        /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ */
        .settings-group {
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 16px;
        }
        .settings-group h3 {
            font-size: 18px;
            margin-bottom: 12px;
            color: var(--text-secondary);
        }
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            cursor: pointer;
        }
        .settings-item .value {
            color: var(--text-secondary);
        }

        .toggle-switch {
            width: 44px;
            height: 24px;
            background: var(--toggle-bg);
            border-radius: 24px;
            position: relative;
            display: inline-block;
            cursor: pointer;
            transition: background 0.2s;
        }
        .toggle-switch.active {
            background: var(--toggle-active);
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s;
        }
        .toggle-switch.active::after {
            transform: translateX(20px);
        }

        .radio-group {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }
        .radio-group label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }
        .wallpaper-preview {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            border: 2px solid transparent;
            transition: border 0.2s;
            cursor: pointer;
        }
        .wallpaper-preview.selected {
            border-color: var(--accent-blue);
        }

        .language-selector {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .lang-btn {
            flex: 1;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .lang-btn.active {
            background: var(--gradient-1);
            color: white;
            border-color: transparent;
        }

        .profile-view {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }
        .profile-view .avatar-large {
            width: 100px;
            height: 100px;
            font-size: 48px;
            background: var(--gradient-1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .profile-view .name {
            font-size: 22px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .profile-view .bio {
            color: var(--text-secondary);
            text-align: center;
        }
        .profile-view .status {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .notification-permission {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            border-radius: 40px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 3000;
        }
        .notification-permission button {
            background: var(--gradient-1);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 30px;
            cursor: pointer;
        }

        /* –†–∞–¥–∏–æ-–∫–Ω–æ–ø–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ */
        .status-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }
        .status-option {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }
        .status-option input[type="radio"] {
            display: none;
        }
        .status-option .radio-custom {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid var(--text-secondary);
            position: relative;
        }
        .status-option input[type="radio"]:checked + .radio-custom {
            border-color: var(--accent-blue);
        }
        .status-option input[type="radio"]:checked + .radio-custom::after {
            content: '';
            width: 12px;
            height: 12px;
            background: var(--accent-blue);
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
        }

        /* –ü–æ–ª–∑—É–Ω–∫–∏ —Ç–µ–º—ã */
        .theme-sliders {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin: 20px 0;
        }
        .slider-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .slider-item label {
            font-size: 14px;
            color: var(--text-secondary);
        }
        .slider-item input[type=range] {
            width: 100%;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }
        .slider-item input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--accent-blue);
            border-radius: 50%;
            cursor: pointer;
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∞–µ—Ç */
        .typing-indicator {
            font-size: 12px;
            color: var(--accent-blue);
            margin-left: 8px;
            animation: blink 1.5s infinite;
        }
        @keyframes blink {
            0% { opacity: 0.3; }
            50% { opacity: 1; }
            100% { opacity: 0.3; }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                z-index: 1000;
                transform: translateX(-100%);
                width: 85%;
                max-width: 320px;
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .back-button {
                display: block;
            }
            .message {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <!-- –ú–æ–¥–∞–ª–∫–∞ –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
    <div class="modal active" id="loginModal">
        <div class="modal-content">
            <h2 data-i18n="welcome">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthMode('login')" id="loginTabBtn" data-i18n="login">–í—Ö–æ–¥</button>
                <button class="auth-tab" onclick="switchAuthMode('register')" id="registerTabBtn" data-i18n="register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            </div>
            <div id="loginForm">
                <input type="text" class="modal-input" id="loginUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" autocomplete="off" data-i18n-placeholder="usernamePlaceholder">
                <div class="password-input-container">
                    <input type="password" class="modal-input" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å" data-i18n-placeholder="passwordPlaceholder">
                    <button class="toggle-password" onclick="togglePassword('loginPassword')">üëÅÔ∏è</button>
                </div>
                <div class="remember-checkbox">
                    <input type="checkbox" id="rememberMe" checked>
                    <label for="rememberMe" data-i18n="rememberMe">–ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è</label>
                </div>
                <button class="modal-btn" onclick="login()" data-i18n="loginBtn">–í–æ–π—Ç–∏</button>
            </div>
            <div id="registerForm" style="display: none;">
                <input type="text" class="modal-input" id="registerUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" maxlength="20" data-i18n-placeholder="usernamePlaceholder">
                <input type="email" class="modal-input" id="registerEmail" placeholder="Email" required data-i18n-placeholder="emailPlaceholder">
                <div class="password-input-container">
                    <input type="password" class="modal-input" id="registerPassword" placeholder="–ü–∞—Ä–æ–ª—å" data-i18n-placeholder="passwordPlaceholder">
                    <button class="toggle-password" onclick="togglePassword('registerPassword')">üëÅÔ∏è</button>
                </div>
                <div class="password-input-container">
                    <input type="password" class="modal-input" id="registerConfirmPassword" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" data-i18n-placeholder="confirmPasswordPlaceholder">
                    <button class="toggle-password" onclick="togglePassword('registerConfirmPassword')">üëÅÔ∏è</button>
                </div>
                <div class="remember-checkbox">
                    <input type="checkbox" id="rememberMeRegister" checked>
                    <label for="rememberMeRegister" data-i18n="rememberMe">–ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è</label>
                </div>
                <button class="modal-btn" onclick="register()" data-i18n="registerBtn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            </div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
    <div class="app-container" id="appContainer" style="display: none;">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="avatar" id="profileAvatar" onclick="openProfileModal()">üë§</div>
                <div class="profile-info">
                    <div class="profile-name" id="profileName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    <div class="profile-status" id="profileStatusDisplay">–æ–Ω–ª–∞–π–Ω <span class="online-indicator"></span></div>
                </div>
            </div>
            <div class="tabs">
                <button class="tab active" onclick="switchTab('chats')" id="tabChats" data-i18n="myChats">–ú–æ–∏ —á–∞—Ç—ã</button>
                <button class="tab" onclick="switchTab('public')" id="tabPublic" data-i18n="public">–ü—É–±–ª–∏—á–Ω—ã–µ</button>
            </div>
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ —á–∞—Ç–æ–≤ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..." oninput="handleSearch()" data-i18n-placeholder="searchAll">
                <button class="create-chat-btn" onclick="openCreateChatModal()">+</button>
            </div>
            <div class="chats-list" id="chatsList"></div>
        </div>

        <div class="chat-area">
            <div class="chat-header">
                <button class="back-button" onclick="toggleSidebar()">‚Üê</button>
                <div class="chat-info">
                    <div class="chat-title">
                        <span id="currentChatName" onclick="openChatInfoModal()">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</span>
                    </div>
                    <div class="chat-subtitle" id="chatStatus"></div>
                    <div id="typingIndicator" class="typing-indicator" style="display: none;"></div>
                </div>
            </div>
            <div class="messages-container" id="messagesContainer"></div>
            <div class="message-input-container">
                <button class="emoji-toggle-btn" onclick="toggleEmojiPicker()">üòä</button>
                <button class="mic-btn" id="micBtn" onclick="toggleSpeechRecognition()">üé§</button>
                <div class="input-wrapper">
                    <div class="emoji-picker" id="emojiPicker" style="display: none;"></div>
                    <textarea class="message-input" id="messageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1" onkeydown="handleKeyPress(event)" data-i18n-placeholder="messagePlaceholder" oninput="sendTyping()"></textarea>
                </div>
                <button class="send-btn" onclick="sendMessage()" id="sendBtn">‚û§</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞ -->
    <div class="modal" id="createChatModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeCreateChatModal()">√ó</button>
            <h2 data-i18n="createPublicChat">–°–æ–∑–¥–∞—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π —á–∞—Ç</h2>
            <input type="text" class="modal-input" id="chatNameInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞" maxlength="30" data-i18n-placeholder="chatNamePlaceholder">
            <input type="text" class="modal-input" id="chatInfoInput" placeholder="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–ø–ø–µ" maxlength="200" data-i18n-placeholder="chatInfoPlaceholder">
            <div class="password-input-container">
                <input type="password" class="modal-input" id="chatPasswordInput" placeholder="–ü–∞—Ä–æ–ª—å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" data-i18n-placeholder="chatPasswordPlaceholder">
                <button class="toggle-password" onclick="togglePassword('chatPasswordInput')">üëÅÔ∏è</button>
            </div>
            <button class="modal-btn" onclick="createPublicChat()" data-i18n="createBtn">–°–æ–∑–¥–∞—Ç—å —á–∞—Ç</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –≤—Ö–æ–¥–∞ –≤ –∑–∞—â–∏—â—ë–Ω–Ω—ã–π —á–∞—Ç -->
    <div class="modal" id="joinChatModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeJoinChatModal()">√ó</button>
            <h2 id="joinChatTitle" data-i18n="enterPassword">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</h2>
            <div class="password-input-container">
                <input type="password" class="modal-input" id="joinPasswordInput" placeholder="–ü–∞—Ä–æ–ª—å —á–∞—Ç–∞" data-i18n-placeholder="chatPasswordPlaceholder">
                <button class="toggle-password" onclick="togglePassword('joinPasswordInput')">üëÅÔ∏è</button>
            </div>
            <button class="modal-btn" onclick="joinProtectedChat()" data-i18n="joinBtn">–í–æ–π—Ç–∏</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è -->
    <div class="modal" id="editMessageModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeEditMessageModal()">√ó</button>
            <h2 data-i18n="editMessage">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h2>
            <textarea class="modal-input" id="editMessageText" rows="3" style="resize: none;"></textarea>
            <button class="modal-btn" onclick="saveEditedMessage()" data-i18n="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ) -->
    <div class="modal" id="profileModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeProfileModal()">√ó</button>
            <h2 data-i18n="editProfile">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h2>
            <div style="text-align: center; margin-bottom: 20px;">
                <div class="avatar" style="width: 80px; height: 80px; font-size: 42px; margin: 0 auto; cursor: pointer;" id="profileAvatarLarge" onclick="openAvatarModal()">üë§</div>
                <small data-i18n="clickToChangeAvatar">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</small>
            </div>
            <input type="text" class="modal-input" id="profileNameInput" placeholder="–ò–º—è (–Ω–∏–∫–Ω–µ–π–º)" maxlength="20" data-i18n-placeholder="namePlaceholder">
            <input type="email" class="modal-input" id="profileEmailInput" placeholder="Email" readonly data-i18n-placeholder="emailPlaceholder">
            <input type="text" class="modal-input" id="profileBioInput" placeholder="–û —Å–µ–±–µ" data-i18n-placeholder="bioPlaceholder">

            <div class="status-options">
                <label class="status-option">
                    <input type="radio" name="status" value="online" onchange="changeStatus('online')">
                    <span class="radio-custom"></span>
                    <span class="status-label" data-i18n="online">–í —Å–µ—Ç–∏</span>
                </label>
                <label class="status-option">
                    <input type="radio" name="status" value="dnd" onchange="changeStatus('dnd')">
                    <span class="radio-custom"></span>
                    <span class="status-label" data-i18n="dnd">–ù–µ –±–µ—Å–ø–æ–∫–æ–∏—Ç—å</span>
                </label>
                <label class="status-option">
                    <input type="radio" name="status" value="invisible" onchange="changeStatus('invisible')">
                    <span class="radio-custom"></span>
                    <span class="status-label" data-i18n="invisible">–ù–µ –≤ —Å–µ—Ç–∏ (–∏–Ω–∫–æ–≥–Ω–∏—Ç–æ)</span>
                </label>
            </div>

            <button class="modal-btn" onclick="saveProfile()" data-i18n="saveProfile">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="modal-btn secondary" onclick="openSettingsModal()" data-i18n="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            <button class="modal-btn danger" onclick="logout()" data-i18n="logout">–í—ã–π—Ç–∏</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —á–∞—Ç–µ -->
    <div class="modal" id="chatInfoModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeChatInfoModal()">√ó</button>
            <h2 id="chatInfoName"></h2>
            <div class="profile-view" id="chatInfoDetails"></div>
            <button class="modal-btn danger" id="deleteChatBtn" onclick="deleteCurrentChat()" style="display: none;" data-i18n="deleteChat">–£–¥–∞–ª–∏—Ç—å —á–∞—Ç</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –≤—ã–±–æ—Ä–∞ –∞–≤–∞—Ç–∞—Ä–∞ -->
    <div class="modal" id="avatarModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeAvatarModal()">√ó</button>
            <h2 data-i18n="chooseAvatar">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä</h2>
            <div class="avatar-grid" id="avatarGrid"></div>
            <button class="modal-btn" onclick="saveAvatar()" data-i18n="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–æ–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è) -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeSettingsModal()">√ó</button>
            <h2 data-i18n="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>

            <div class="settings-group">
                <h3 data-i18n="appearance">–í–Ω–µ—à–Ω–∏–π –≤–∏–¥</h3>
                <div class="settings-item" onclick="toggleHideLastSeen()">
                    <span data-i18n="hideLastSeen">–°–∫—Ä—ã—Ç—å –≤—Ä–µ–º—è –∑–∞—Ö–æ–¥–∞</span>
                    <div class="toggle-switch" id="hideLastSeenToggle"></div>
                </div>
                <div class="settings-item" onclick="openThemeModal()">
                    <span data-i18n="theme">–¢–µ–º–∞ (—Ü–≤–µ—Ç–∞)</span>
                    <span class="value" id="currentTheme">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è</span>
                </div>
                <div class="settings-item">
                    <span data-i18n="fontSize">–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞</span>
                    <div class="radio-group">
                        <label><input type="radio" name="fontSize" value="small" onchange="setFontSize('small')"> –ú–∞–ª–µ–Ω—å–∫–∏–π</label>
                        <label><input type="radio" name="fontSize" value="medium" onchange="setFontSize('medium')" checked> –°—Ä–µ–¥–Ω–∏–π</label>
                        <label><input type="radio" name="fontSize" value="large" onchange="setFontSize('large')"> –ë–æ–ª—å—à–æ–π</label>
                    </div>
                </div>
                <div class="settings-item">
                    <span data-i18n="compactMode">–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º</span>
                    <div class="toggle-switch" id="compactModeToggle" onclick="toggleCompactMode()"></div>
                </div>
                <div class="settings-item">
                    <span data-i18n="wallpaper">–û–±–æ–∏ —á–∞—Ç–∞</span>
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <div class="wallpaper-preview" style="background: var(--bg-primary);" onclick="setWallpaper('default')"></div>
                        <div class="wallpaper-preview" style="background: radial-gradient(circle at 30% 40%, #ff8a5c, #ff4d4d);" onclick="setWallpaper('gradient1')"></div>
                        <div class="wallpaper-preview" style="background: linear-gradient(135deg, #667eea, #764ba2);" onclick="setWallpaper('gradient2')"></div>
                        <div class="wallpaper-preview" style="background: repeating-linear-gradient(45deg, #3f87a6, #ebf8e1 20px);" onclick="setWallpaper('gradient3')"></div>
                    </div>
                </div>
            </div>

            <div class="settings-group">
                <h3 data-i18n="notifications">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
                <div class="settings-item" onclick="toggleSoundNotifications()">
                    <span data-i18n="soundNotifications">–ó–≤—É–∫–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
                    <div class="toggle-switch" id="soundToggle"></div>
                </div>
                <div class="settings-item" onclick="requestNotificationPermission()">
                    <span data-i18n="browserNotifications">–ë—Ä–∞—É–∑–µ—Ä–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
                    <span class="value" id="notificationStatus">–†–∞–∑—Ä–µ—à–∏—Ç—å</span>
                </div>
            </div>

            <div class="settings-group">
                <h3 data-i18n="languageRegion">–Ø–∑—ã–∫</h3>
                <div class="settings-item" onclick="openLanguageModal()">
                    <span data-i18n="language">–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</span>
                    <span class="value" id="currentLanguage">–†—É—Å—Å–∫–∏–π</span>
                </div>
            </div>

            <button class="modal-btn secondary" onclick="closeSettingsModal()" data-i18n="close">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞ -->
    <div class="modal" id="languageModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeLanguageModal()">√ó</button>
            <h2 data-i18n="selectLanguage">–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫</h2>
            <div class="language-selector">
                <button class="lang-btn" onclick="setLanguage('ru')" id="langRu">–†—É—Å—Å–∫–∏–π</button>
                <button class="lang-btn" onclick="setLanguage('en')" id="langEn">English</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–º—ã (—Å –ø–æ–ª–∑—É–Ω–∫–∞–º–∏) -->
    <div class="modal" id="themeModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeThemeModal()">√ó</button>
            <h2 data-i18n="customizeTheme">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ–º—ã</h2>
            <div class="theme-sliders">
                <div class="slider-item">
                    <label data-i18n="hue">–û—Ç—Ç–µ–Ω–æ–∫</label>
                    <input type="range" id="hueSlider" min="0" max="360" value="210" oninput="updateThemeFromSliders()">
                </div>
                <div class="slider-item">
                    <label data-i18n="saturation">–ù–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å</label>
                    <input type="range" id="saturationSlider" min="0" max="100" value="80" oninput="updateThemeFromSliders()">
                </div>
                <div class="slider-item">
                    <label data-i18n="lightness">–Ø—Ä–∫–æ—Å—Ç—å</label>
                    <input type="range" id="lightnessSlider" min="20" max="80" value="60" oninput="updateThemeFromSliders()">
                </div>
            </div>
            <button class="modal-btn" onclick="saveTheme()" data-i18n="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ—Ñ–∏–ª—è —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ -->
    <div class="modal" id="userProfileModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeUserProfileModal()">√ó</button>
            <div class="profile-view" id="userProfileView"></div>
        </div>
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–ø—Ä–æ—Å–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ push -->
    <div class="notification-permission" id="notificationPermission" style="display: none;">
        <span data-i18n="allowNotifications">–†–∞–∑—Ä–µ—à–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è?</span>
        <button onclick="requestNotificationPermission()" data-i18n="allow">–†–∞–∑—Ä–µ—à–∏—Ç—å</button>
    </div>

    <script>
        // ==================== –ü–û–õ–ù–´–ô –ü–ï–†–ï–†–ê–ë–û–¢–ê–ù–ù–´–ô –ö–û–î ====================
        // –í–µ—Ä—Å–∏—è 3.0 ‚Äî –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π, –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ —á–∞—Ç—ã, –Ω–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

        // -------------------- –õ–û–ö–ê–õ–ò–ó–ê–¶–ò–Ø --------------------
        const i18n = {
            currentLang: 'ru',
            translations: {
                ru: {
                    welcome: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!',
                    login: '–í—Ö–æ–¥',
                    register: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è',
                    usernamePlaceholder: '–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
                    emailPlaceholder: 'Email',
                    passwordPlaceholder: '–ü–∞—Ä–æ–ª—å',
                    confirmPasswordPlaceholder: '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å',
                    rememberMe: '–ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è',
                    loginBtn: '–í–æ–π—Ç–∏',
                    registerBtn: '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è',
                    myChats: '–ú–æ–∏ —á–∞—Ç—ã',
                    public: '–ü—É–±–ª–∏—á–Ω—ã–µ',
                    searchAll: '–ü–æ–∏—Å–∫ —á–∞—Ç–æ–≤ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...',
                    messagePlaceholder: '–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...',
                    createPublicChat: '–°–æ–∑–¥–∞—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π —á–∞—Ç',
                    chatNamePlaceholder: '–ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞',
                    chatInfoPlaceholder: '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–ø–ø–µ',
                    chatPasswordPlaceholder: '–ü–∞—Ä–æ–ª—å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)',
                    createBtn: '–°–æ–∑–¥–∞—Ç—å —á–∞—Ç',
                    enterPassword: '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å',
                    joinBtn: '–í–æ–π—Ç–∏',
                    editMessage: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ',
                    save: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
                    editProfile: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å',
                    clickToChangeAvatar: '–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä',
                    namePlaceholder: '–ò–º—è (–Ω–∏–∫–Ω–µ–π–º)',
                    bioPlaceholder: '–û —Å–µ–±–µ',
                    online: '–í —Å–µ—Ç–∏',
                    dnd: '–ù–µ –±–µ—Å–ø–æ–∫–æ–∏—Ç—å',
                    invisible: '–ù–µ –≤ —Å–µ—Ç–∏ (–∏–Ω–∫–æ–≥–Ω–∏—Ç–æ)',
                    saveProfile: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
                    settings: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
                    logout: '–í—ã–π—Ç–∏',
                    chooseAvatar: '–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä',
                    hideLastSeen: '–°–∫—Ä—ã—Ç—å –≤—Ä–µ–º—è –∑–∞—Ö–æ–¥–∞',
                    language: '–Ø–∑—ã–∫',
                    theme: '–¢–µ–º–∞',
                    customizeTheme: '–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ–º—ã',
                    hue: '–û—Ç—Ç–µ–Ω–æ–∫',
                    saturation: '–ù–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å',
                    lightness: '–Ø—Ä–∫–æ—Å—Ç—å',
                    selectLanguage: '–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫',
                    lastSeen: '–ë—ã–ª(–∞)',
                    recently: '–Ω–µ–¥–∞–≤–Ω–æ',
                    onlineNow: '–≤ —Å–µ—Ç–∏',
                    dndStatus: '–Ω–µ –±–µ—Å–ø–æ–∫–æ–∏—Ç',
                    offline: '–Ω–µ –≤ —Å–µ—Ç–∏',
                    noBio: '–ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏',
                    delete: '–£–¥–∞–ª–∏—Ç—å',
                    edit: '–†–µ–¥.',
                    deleteChat: '–£–¥–∞–ª–∏—Ç—å —á–∞—Ç',
                    chatDeleted: '‚ö†Ô∏è –ß–∞—Ç –±—ã–ª —É–¥–∞–ª–µ–Ω',
                    noMessages: '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å!',
                    selectChat: 'üëà –í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç',
                    nothingFound: '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ',
                    areYouSure: '–í—ã —É–≤–µ—Ä–µ–Ω—ã?',
                    wrongPassword: '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å',
                    fillAllFields: '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è',
                    passwordsDoNotMatch: '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç',
                    passwordTooShort: '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞',
                    userExists: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç',
                    emailExists: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç',
                    tooManyAttempts: '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.',
                    recording: '–ó–∞–ø–∏—Å—å...',
                    speechNotSupported: '–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏',
                    microphoneError: '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É',
                    allowNotifications: '–†–∞–∑—Ä–µ—à–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è?',
                    allow: '–†–∞–∑—Ä–µ—à–∏—Ç—å',
                    minutesAgo: '–º–∏–Ω –Ω–∞–∑–∞–¥',
                    hoursAgo: '—á –Ω–∞–∑–∞–¥',
                    daysAgo: '–¥ –Ω–∞–∑–∞–¥',
                    justNow: '—Ç–æ–ª—å–∫–æ —á—Ç–æ',
                    owner: '–≤–ª–∞–¥–µ–ª–µ—Ü',
                    createdBy: '–°–æ–∑–¥–∞—Ç–µ–ª—å',
                    description: '–û–ø–∏—Å–∞–Ω–∏–µ',
                    members: '–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤',
                    appearance: '–í–Ω–µ—à–Ω–∏–π –≤–∏–¥',
                    fontSize: '–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞',
                    compactMode: '–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º',
                    wallpaper: '–û–±–æ–∏',
                    notifications: '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è',
                    soundNotifications: '–ó–≤—É–∫–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è',
                    browserNotifications: '–ë—Ä–∞—É–∑–µ—Ä–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è',
                    languageRegion: '–Ø–∑—ã–∫ –∏ —Ä–µ–≥–∏–æ–Ω',
                    close: '–ó–∞–∫—Ä—ã—Ç—å',
                    typing: '–ø–µ—á–∞—Ç–∞–µ—Ç...',
                },
                en: {
                    welcome: 'Welcome!',
                    login: 'Login',
                    register: 'Register',
                    usernamePlaceholder: 'Username',
                    emailPlaceholder: 'Email',
                    passwordPlaceholder: 'Password',
                    confirmPasswordPlaceholder: 'Confirm password',
                    rememberMe: 'Remember me',
                    loginBtn: 'Login',
                    registerBtn: 'Register',
                    myChats: 'My Chats',
                    public: 'Public',
                    searchAll: 'Search chats and users...',
                    messagePlaceholder: 'Write a message...',
                    createPublicChat: 'Create Public Chat',
                    chatNamePlaceholder: 'Chat name',
                    chatInfoPlaceholder: 'Group info',
                    chatPasswordPlaceholder: 'Password (optional)',
                    createBtn: 'Create Chat',
                    enterPassword: 'Enter password',
                    joinBtn: 'Join',
                    editMessage: 'Edit Message',
                    save: 'Save',
                    editProfile: 'Edit Profile',
                    clickToChangeAvatar: 'Click to change avatar',
                    namePlaceholder: 'Name (nickname)',
                    bioPlaceholder: 'About',
                    online: 'Online',
                    dnd: 'Do Not Disturb',
                    invisible: 'Offline (incognito)',
                    saveProfile: 'Save',
                    settings: 'Settings',
                    logout: 'Logout',
                    chooseAvatar: 'Choose Avatar',
                    hideLastSeen: 'Hide last seen',
                    language: 'Language',
                    theme: 'Theme',
                    customizeTheme: 'Customize Theme',
                    hue: 'Hue',
                    saturation: 'Saturation',
                    lightness: 'Lightness',
                    selectLanguage: 'Select language',
                    lastSeen: 'Last seen',
                    recently: 'recently',
                    onlineNow: 'online',
                    dndStatus: 'do not disturb',
                    offline: 'offline',
                    noBio: 'No information',
                    delete: 'Delete',
                    edit: 'Edit',
                    deleteChat: 'Delete chat',
                    chatDeleted: '‚ö†Ô∏è Chat was deleted',
                    noMessages: 'No messages. Write something!',
                    selectChat: 'üëà Select a chat',
                    nothingFound: 'Nothing found',
                    areYouSure: 'Are you sure?',
                    wrongPassword: 'Wrong password',
                    fillAllFields: 'Fill all fields',
                    passwordsDoNotMatch: 'Passwords do not match',
                    passwordTooShort: 'Password must be at least 3 characters',
                    userExists: 'User with this name already exists',
                    emailExists: 'User with this email already exists',
                    tooManyAttempts: 'Too many attempts. Try later.',
                    recording: 'Recording...',
                    speechNotSupported: 'Your browser does not support speech recognition',
                    microphoneError: 'Microphone access error',
                    allowNotifications: 'Allow notifications?',
                    allow: 'Allow',
                    minutesAgo: 'min ago',
                    hoursAgo: 'h ago',
                    daysAgo: 'd ago',
                    justNow: 'just now',
                    owner: 'owner',
                    createdBy: 'Created by',
                    description: 'Description',
                    members: 'Members',
                    appearance: 'Appearance',
                    fontSize: 'Font size',
                    compactMode: 'Compact mode',
                    wallpaper: 'Wallpaper',
                    notifications: 'Notifications',
                    soundNotifications: 'Sound notifications',
                    browserNotifications: 'Browser notifications',
                    languageRegion: 'Language & region',
                    close: 'Close',
                    typing: 'typing...',
                }
            },
            t(key) { return this.translations[this.currentLang][key] || key; },
            setLang(lang) {
                if (this.translations[lang]) {
                    this.currentLang = lang;
                    document.documentElement.lang = lang;
                    this.updateUI();
                }
            },
            updateUI() {
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    el.textContent = this.t(key);
                });
                document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                    const key = el.getAttribute('data-i18n-placeholder');
                    el.placeholder = this.t(key);
                });
                const joinTitle = document.getElementById('joinChatTitle');
                if (joinTitle) joinTitle.textContent = this.t('enterPassword');
                const langSpan = document.getElementById('currentLanguage');
                if (langSpan) langSpan.textContent = this.currentLang === 'ru' ? '–†—É—Å—Å–∫–∏–π' : 'English';
            }
        };

        // -------------------- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï --------------------
        const ABLY_API_KEY = "pYHevw.VrFP9Q:8u3IGeMI56PtA4S6Z_VCVvvXpEXEmiIlfoAjfPb6BZg";
        let ably;
        let currentUser = null;
        let users = JSON.parse(localStorage.getItem('telegram_users')) || {};
        let publicChats = JSON.parse(localStorage.getItem('publicChats')) || [];
        let myChats = [];
        let onlineUsers = {}; // clientId -> –¥–∞–Ω–Ω—ã–µ + lastSeen
        let currentChat = null;
        let messages = JSON.parse(localStorage.getItem('messages')) || {};
        let unreadCounts = JSON.parse(localStorage.getItem('unreadCounts')) || {};
        let currentTab = 'chats';
        let pendingChatToJoin = null;
        let messageToEdit = null;
        const ADMIN_USERNAME = "K1lame";
        const TESTER_USERNAME = "martin_dev";
        let deletedMessages = JSON.parse(localStorage.getItem('deletedMessages')) || {};

        // –î–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç —Å–ø–∞–º–∞
        let lastMessageTime = 0;
        const MESSAGE_COOLDOWN = 1000;
        let sendBtnDisabled = false;
        let loginAttempts = 0;
        let lastLoginAttemptTime = 0;
        const MAX_LOGIN_ATTEMPTS = 15;
        const LOGIN_TIMEFRAME = 60000;

        // –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏
        let recognition = null;
        let isRecording = false;

        // –ó–≤—É–∫
        let soundEnabled = localStorage.getItem('soundEnabled') !== 'false';

        // –¢–∞–π–º–µ—Ä –¥–ª—è "–ø–µ—á–∞—Ç–∞–µ—Ç..."
        let typingTimeout = null;

        // –≠–º–æ–¥–∑–∏ (–ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä)
        const emojiList = ['üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'üòÇ', 'ü§£', 'üòä', 'üòá', 'üôÇ', 'üôÉ', 'üòâ', 'üòå', 'üòç', 'ü•∞', 'üòò', 'üòó', 'üòô', 'üòö', 'üòã', 'üòõ', 'üòù', 'üòú', 'ü§™', 'ü§®', 'üßê', 'ü§ì', 'üòé', 'ü•∏', 'ü§©', 'ü•≥', 'üòè', 'üòí', 'üòû', 'üòî', 'üòü', 'üòï', 'üôÅ', '‚òπÔ∏è', 'üò£', 'üòñ', 'üò´', 'üò©', 'ü•∫', 'üò¢', 'üò≠', 'üò§', 'üò†', 'üò°', 'ü§¨', 'ü§Ø', 'üò≥', 'ü•µ', 'ü•∂', 'üò±', 'üò®', 'üò∞', 'üò•', 'üòì', 'ü§ó', 'ü§î', 'ü§≠', 'ü§´', 'ü§•', 'üò∂', 'üòê', 'üòë', 'üò¨', 'üôÑ', 'üòØ', 'üò¶', 'üòß', 'üòÆ', 'üò≤', 'ü•±', 'üò¥', 'ü§§', 'üò™', 'üòµ', 'ü§ê', 'ü•¥', 'ü§¢', 'ü§Æ', 'ü§ß', 'üò∑', 'ü§í', 'ü§ï', 'ü§ë', 'ü§†', 'üòà', 'üëø', 'üëπ', 'üë∫', 'üíÄ', 'üëª', 'üëΩ', 'ü§ñ', 'üí©', 'üò∫', 'üò∏', 'üòπ', 'üòª', 'üòº', 'üòΩ', 'üôÄ', 'üòø', 'üòæ', 'üôà', 'üôâ', 'üôä', 'üëã', 'ü§ö', 'üñê', '‚úã', 'üññ', 'üëå', 'ü§å', 'ü§è', '‚úåÔ∏è', 'ü§û', 'ü§ü', 'ü§ò', 'ü§ô', 'üëà', 'üëâ', 'üëÜ', 'üñï', 'üëá', '‚òùÔ∏è', 'üëç', 'üëé', '‚úä', 'üëä', 'ü§õ', 'ü§ú', 'üëè', 'üôå', 'üëê', 'ü§≤', 'ü§ù', 'üôè', '‚úçÔ∏è', 'üíÖ', 'ü§≥', 'üí™', 'ü¶æ', 'ü¶ø', 'ü¶µ', 'ü¶∂', 'üëÇ', 'ü¶ª', 'üëÉ', 'üß†', 'ü¶∑', 'ü¶¥', 'üëÄ', 'üëÅ', 'üëÖ', 'üëÑ', 'üíã', 'ü©∏', '‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üíü', '‚òÆÔ∏è', '‚úùÔ∏è', '‚ò™Ô∏è', 'üïâÔ∏è', '‚ò∏Ô∏è', '‚ú°Ô∏è', 'üîØ', 'üïé', '‚òØÔ∏è', '‚ò¶Ô∏è', 'üõê', '‚õé', '‚ôà', '‚ôâ', '‚ôä', '‚ôã', '‚ôå', '‚ôç', '‚ôé', '‚ôè', '‚ôê', '‚ôë', '‚ôí', '‚ôì', 'üÜî', '‚öõÔ∏è', 'üâë', '‚ò¢Ô∏è', '‚ò£Ô∏è', 'üì¥', 'üì≥', 'üà∂', 'üàö', 'üà∏', 'üà∫', 'üà∑Ô∏è', '‚ú¥Ô∏è', 'üÜö', 'üíÆ', 'üâê', '„äôÔ∏è', '„äóÔ∏è', 'üà¥', 'üàµ', 'üàπ', 'üà≤', 'üÖ∞Ô∏è', 'üÖ±Ô∏è', 'üÜé', 'üÜë', 'üÖæÔ∏è', 'üÜò', '‚ùå', '‚≠ï', 'üõë', '‚õî', 'üìõ', 'üö´', 'üíØ', 'üí¢', '‚ô®Ô∏è', 'üö∑', 'üöØ', 'üö≥', 'üö±', 'üîû', 'üìµ', 'üö≠', '‚ùó', '‚ùï', '‚ùì', '‚ùî', '‚ÄºÔ∏è', '‚ÅâÔ∏è', 'üîÖ', 'üîÜ', '„ÄΩÔ∏è', '‚ö†Ô∏è', 'üö∏', 'üî±', '‚öúÔ∏è', 'üî∞', '‚ôªÔ∏è', '‚úÖ', 'üàØ', 'üíπ', '‚ùáÔ∏è', '‚ú≥Ô∏è', '‚ùé', 'üåê', 'üí†', '‚ìÇÔ∏è', 'üåÄ', 'üí§', 'üèß', 'üöπ', 'üö∫', 'üöº', 'üöª', 'üöÆ', 'üé¶', 'üì∂', 'üàÅ', 'üî£', '‚ÑπÔ∏è', 'üî§', 'üî°', 'üî†', 'üÜñ', 'üÜó', 'üÜô', 'üÜí', 'üÜï', 'üÜì', '0Ô∏è‚É£', '1Ô∏è‚É£', '2Ô∏è‚É£', '3Ô∏è‚É£', '4Ô∏è‚É£', '5Ô∏è‚É£', '6Ô∏è‚É£', '7Ô∏è‚É£', '8Ô∏è‚É£', '9Ô∏è‚É£', 'üîü', 'üî¢', '#Ô∏è‚É£', '*Ô∏è‚É£', '‚èèÔ∏è', '‚ñ∂Ô∏è', '‚è∏Ô∏è', '‚èØÔ∏è', '‚èπÔ∏è', '‚è∫Ô∏è', '‚è≠Ô∏è', '‚èÆÔ∏è', '‚è©', '‚è™', '‚è´', '‚è¨', '‚óÄÔ∏è', 'üîº', 'üîΩ', '‚û°Ô∏è', '‚¨ÖÔ∏è', '‚¨ÜÔ∏è', '‚¨áÔ∏è', '‚ÜóÔ∏è', '‚ÜòÔ∏è', '‚ÜôÔ∏è', '‚ÜñÔ∏è', '‚ÜïÔ∏è', 'üîÑ', '‚Ü™Ô∏è', '‚Ü©Ô∏è', '‚§¥Ô∏è', '‚§µÔ∏è', 'üîÄ', 'üîÅ', 'üîÇ', 'üîÉ', 'üéµ', 'üé∂', '‚ûï', '‚ûñ', '‚ûó', '‚úñÔ∏è', '‚ôæÔ∏è', 'üí≤', 'üí±', '‚Ñ¢Ô∏è', '¬©Ô∏è', '¬ÆÔ∏è', '„Ä∞Ô∏è', '‚û∞', '‚ûø', 'üîö', 'üîô', 'üîõ', 'üîù', 'üîú', '‚úîÔ∏è', '‚òëÔ∏è', 'üîò', 'üî¥', 'üü†', 'üü°', 'üü¢', 'üîµ', 'üü£', 'üü§', '‚ö´', '‚ö™', 'üü•', 'üüß', 'üü®', 'üü©', 'üü¶', 'üü™', 'üü´', '‚¨õ', '‚¨ú', '‚óºÔ∏è', '‚óªÔ∏è', '‚óæ', '‚óΩ', '‚ñ™Ô∏è', '‚ñ´Ô∏è', 'üî∂', 'üî∑', 'üî∏', 'üîπ', 'üî∫', 'üîª', 'üí≠', 'üóØÔ∏è', 'üí¨', 'üëÅÔ∏è‚Äçüó®Ô∏è', 'üó®Ô∏è', 'üïê', 'üïë', 'üïí', 'üïì', 'üïî', 'üïï', 'üïñ', 'üïó', 'üïò', 'üïô', 'üïö', 'üïõ', 'üïú', 'üïù', 'üïû', 'üïü', 'üï†', 'üï°', 'üï¢', 'üï£', 'üï§', 'üï•', 'üï¶', 'üïß'];

        // –ó–∞–±–∞–≤–Ω—ã–µ –∞–≤–∞—Ç–∞—Ä–∫–∏
        const weirdEmojis = ['üëæ', 'ü§ñ', 'üëΩ', 'üíÄ', 'üëª', 'üëπ', 'üë∫', 'ü§°', 'üí©', 'üî•', 'üåÄ', 'üåö', 'üåù', '‚≠ê', 'üåü', 'üí´', '‚ú®', '‚ö°', '‚òÑÔ∏è', 'üí•', 'üï≥Ô∏è', 'üëÅÔ∏è', 'üß†', 'üëÖ', 'üëÑ', 'ü¶∑', 'ü¶¥', 'üëÄ', 'üëÉ', 'üëÇ', 'üçë', 'üçÜ', 'ü•ë', 'üåÆ', 'üçï', 'üçî', 'üçü', 'üå≠', 'üçø', 'ü•®', 'üßÄ', 'ü•©', 'ü•ì', 'üçó', 'üçñ', 'ü¶¥', 'ü•°', 'ü•¢', 'üçΩÔ∏è', 'üî™', 'ü™ì', '‚ö∞Ô∏è', '‚ö±Ô∏è', 'üßø', 'üîÆ', 'üìø', 'üíé', 'üî´', 'üí£', 'üß®', 'üõ°Ô∏è', 'üèπ', 'üó°Ô∏è', '‚öîÔ∏è', 'üîß', 'üî®', '‚õèÔ∏è', '‚öíÔ∏è', 'üõ†Ô∏è', 'üî©', 'üêâ', 'üê≤', 'üåä', 'üßô', 'üßù', 'üßû', 'üßü', 'üßå', 'ü¶Ñ', 'üê≤', 'ü¶•', 'ü¶¶', 'ü¶®', 'ü¶©', 'ü¶ö', 'ü¶ú', 'üêß', 'üê£', 'üê§', 'üê•', 'üê¶', 'üêß', 'üê¶‚Äç‚¨õ', 'üïäÔ∏è', 'ü¶Ö', 'ü¶Ü', 'ü¶â', 'üê∫', 'üêó', 'üê¥', 'ü¶Ñ', 'üêù', 'üêû', 'ü¶ã', 'üêå', 'üêõ', 'ü¶ü', 'ü¶ó', 'üêú', 'üêù', 'üêû', 'ü¶Ç', 'üï∑Ô∏è', 'üï∏Ô∏è', 'ü¶†', 'üåø', 'üçÄ', 'üå±', 'üå≤', 'üå≥', 'üå¥', 'üåµ', 'üåæ', 'üåø', 'üçÉ', 'üçÇ', 'üçÅ', 'üå∫', 'üåª', 'üåº', 'üå∑', 'üå∏', 'üíê', 'ü•Ä', 'üåπ', 'ü™ª', 'ü™∑', 'üåΩ', 'ü•ï', 'ü•î', 'üßÑ', 'üßÖ', 'ü•¶', 'ü•¨', 'ü•í', 'üå∂Ô∏è', 'ü´ë', 'ü•ï', 'üç†', 'ü•ú', 'ü´ò', 'üå∞', 'üçÑ', 'ü™¥', 'üéç', 'ü™µ', 'ü™®', 'üèîÔ∏è', '‚õ∞Ô∏è', 'üåã', 'üèúÔ∏è', 'üèùÔ∏è', 'üèûÔ∏è', 'üèüÔ∏è', 'üèõÔ∏è', 'üèóÔ∏è', 'üèòÔ∏è', 'üèöÔ∏è', 'üè†', 'üè°', 'üè¢', 'üè£', 'üè§', 'üè•', 'üè¶', 'üè®', 'üè©', 'üè™', 'üè´', 'üè¨', 'üè≠', 'üèØ', 'üè∞', 'üíí', 'üóº', 'üóΩ', '‚õ≤', '‚õ∫', 'üåÅ', 'üåÉ', 'üåÜ', 'üåá', 'üåâ', 'üé†', 'üé°', 'üé¢', 'üöÇ', 'üöÉ', 'üöÑ', 'üöÖ', 'üöÜ', 'üöá', 'üöà', 'üöâ', 'üöä', 'üöù', 'üöû', 'üöã', 'üöå', 'üöç', 'üöé', 'üöê', 'üöë', 'üöí', 'üöì', 'üöî', 'üöï', 'üöñ', 'üöó', 'üöò', 'üöô', 'üöö', 'üöõ', 'üöú', 'üõµ', 'üèçÔ∏è', 'üõ∫', 'üö≤', 'üõ¥', 'üöè', 'üõë', 'üõû', 'üõü', '‚õµ', 'üõ∂', 'üö§', 'üõ≥Ô∏è', '‚õ¥Ô∏è', 'üõ•Ô∏è', 'üö¢', '‚úàÔ∏è', 'üõ©Ô∏è', 'üõ´', 'üõ¨', 'ü™Ç', 'üöÅ', 'üöü', 'üö†', 'üö°', 'üõ∞Ô∏è', 'üöÄ', 'üõ∏', 'üåå', '‚è±Ô∏è', '‚è≤Ô∏è', 'üï∞Ô∏è', '‚åõ', '‚è≥', '‚åö', '‚è∞', 'üå°Ô∏è', '‚òÄÔ∏è', '‚òÅÔ∏è', '‚õÖ', '‚õàÔ∏è', 'üå§Ô∏è', 'üå•Ô∏è', 'üå¶Ô∏è', 'üåßÔ∏è', 'üå®Ô∏è', 'üå©Ô∏è', 'üå™Ô∏è', 'üå´Ô∏è', 'üå¨Ô∏è', 'üåÄ', 'üåà', 'üåÇ', '‚òî', '‚õ±Ô∏è', '‚ö°', '‚ùÑÔ∏è', '‚òÉÔ∏è', '‚õÑ', 'üî•', 'üíß', 'üåä'];

        // -------------------- –°–ë–†–û–° –í–°–ï–• –ß–ê–¢–û–í –ü–†–ò –ü–ï–†–í–û–ú –ó–ê–ü–£–°–ö–ï --------------------
        (function resetAllChats() {
            if (!localStorage.getItem('initialized')) {
                localStorage.setItem('publicChats', JSON.stringify([]));
                localStorage.setItem('messages', JSON.stringify({}));
                localStorage.setItem('unreadCounts', JSON.stringify({}));
                localStorage.setItem('deletedMessages', JSON.stringify({}));
                // –£–¥–∞–ª—è–µ–º myChats –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                for (let key in users) {
                    localStorage.removeItem(`myChats_${users[key].id}`);
                }
                localStorage.setItem('initialized', 'true');
                console.log('–í—Å–µ —á–∞—Ç—ã —Å–±—Ä–æ—à–µ–Ω—ã.');
            }
        })();

        // -------------------- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô --------------------
        function initDefaultUsers() {
            // –°–æ–∑–¥–∞—ë–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è martin_dev, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            const testerKey = TESTER_USERNAME.toLowerCase();
            if (!users[testerKey]) {
                users[testerKey] = {
                    id: 'user_' + Date.now() + '_tester',
                    name: TESTER_USERNAME,
                    email: 'martin@example.com',
                    password: 'Andrey10987654321!',
                    avatar: 'üß™',
                    bio: '–¢–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫',
                    status: 'online',
                    hideLastSeen: false,
                    language: 'ru',
                    theme: 'dark',
                    isTester: true,
                    createdAt: new Date().toISOString()
                };
            }
            // –°–æ–∑–¥–∞—ë–º –∞–¥–º–∏–Ω–∞ K1lame, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            const adminKey = ADMIN_USERNAME.toLowerCase();
            if (!users[adminKey]) {
                users[adminKey] = {
                    id: 'user_' + Date.now() + '_admin',
                    name: ADMIN_USERNAME,
                    email: 'admin@example.com',
                    password: 'admin123', // –ø–∞—Ä–æ–ª—å admin123
                    avatar: 'üëë',
                    bio: '–°–æ–∑–¥–∞—Ç–µ–ª—å',
                    status: 'online',
                    hideLastSeen: false,
                    language: 'ru',
                    theme: 'dark',
                    isAdmin: true,
                    createdAt: new Date().toISOString()
                };
            } else {
                users[adminKey].isAdmin = true;
                users[adminKey].bio = '–°–æ–∑–¥–∞—Ç–µ–ª—å';
            }
            localStorage.setItem('telegram_users', JSON.stringify(users));
        }

        // –ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –ø–æ–ª–µ–π)
        function migrateUsers() {
            for (let key in users) {
                const u = users[key];
                if (!u.email) u.email = u.name + '@localhost';
                if (!u.status) u.status = 'online';
                if (u.hideLastSeen === undefined) u.hideLastSeen = false;
                if (!u.language) u.language = 'ru';
                if (!u.theme) u.theme = 'dark';
                if (!u.avatar) u.avatar = 'üë§';
                if (!u.bio) u.bio = '';
                if (u.name === ADMIN_USERNAME) u.isAdmin = true;
                if (u.name === TESTER_USERNAME) u.isTester = true;
            }
            localStorage.setItem('telegram_users', JSON.stringify(users));
        }

        // -------------------- –ü–†–û–í–ï–†–ö–ê –°–û–•–†–ê–ù–Å–ù–ù–û–ô –°–ï–°–°–ò–ò --------------------
        function checkSavedSession() {
            initDefaultUsers();
            migrateUsers();

            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    const userKey = currentUser.name.toLowerCase();
                    if (users[userKey]) {
                        currentUser = { ...users[userKey], password: undefined };
                        currentUser.isAdmin = users[userKey].isAdmin || false;
                        currentUser.isTester = users[userKey].isTester || false;
                    }
                    myChats = JSON.parse(localStorage.getItem(`myChats_${currentUser.id}`)) || [];
                    document.getElementById('loginModal').classList.remove('active');
                    document.getElementById('appContainer').style.display = 'flex';
                    updateProfileUI();
                    setTimeout(() => {
                        initAbly();
                        checkUrlForChat();
                    }, 100);
                } catch (e) {
                    console.error('Failed to load session', e);
                }
            }
            if (currentUser && currentUser.language) {
                i18n.setLang(currentUser.language);
            } else {
                i18n.setLang('ru');
            }
            if (currentUser && currentUser.theme) {
                document.documentElement.style.setProperty('--hue', currentUser.hue || '210');
                document.documentElement.style.setProperty('--saturation', (currentUser.saturation || '80') + '%');
                document.documentElement.style.setProperty('--lightness', (currentUser.lightness || '60') + '%');
            }
            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
            if (currentUser) {
                setFontSize(currentUser.fontSize || 'medium');
                if (currentUser.compactMode) document.body.classList.add('compact-mode');
                if (currentUser.wallpaper) setWallpaper(currentUser.wallpaper);
                document.getElementById('soundToggle').className = soundEnabled ? 'toggle-switch active' : 'toggle-switch';
            }
            if (Notification.permission === 'default') {
                document.getElementById('notificationPermission').style.display = 'flex';
            }
        }

        // -------------------- –û–ë–ù–û–í–õ–ï–ù–ò–ï UI –ü–†–û–§–ò–õ–Ø --------------------
        function updateProfileUI() {
            if (!currentUser) return;
            const nameSpan = document.getElementById('profileName');
            let badges = '';
            if (currentUser.isAdmin) {
                badges += '<span class="admin-badge">–°–æ–∑–¥–∞—Ç–µ–ª—å</span>';
            } else if (currentUser.isTester) {
                badges += '<span class="tester-badge">–¢–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫</span>';
            }
            nameSpan.innerHTML = `${escapeHtml(currentUser.name)} ${badges}`;

            const statusDisplay = document.getElementById('profileStatusDisplay');
            if (currentUser.status === 'dnd') {
                statusDisplay.innerHTML = i18n.t('dnd') + ' <span class="dnd-badge">DND</span>';
            } else if (currentUser.status === 'invisible') {
                statusDisplay.innerHTML = i18n.t('offline');
            } else {
                statusDisplay.innerHTML = i18n.t('online') + ' <span class="online-indicator"></span>';
            }
            document.getElementById('profileAvatar').textContent = currentUser.avatar || 'üë§';
            document.getElementById('profileAvatarLarge').textContent = currentUser.avatar || 'üë§';
            document.getElementById('profileNameInput').value = currentUser.name;
            document.getElementById('profileEmailInput').value = currentUser.email || '';
            document.getElementById('profileBioInput').value = currentUser.bio || '';

            const radios = document.querySelectorAll('input[name="status"]');
            for (let r of radios) {
                if (r.value === currentUser.status) r.checked = true;
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // -------------------- –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø --------------------
        function requestNotificationPermission() {
            Notification.requestPermission().then(perm => {
                if (perm === 'granted') {
                    document.getElementById('notificationPermission').style.display = 'none';
                    document.getElementById('notificationStatus').textContent = '–†–∞–∑—Ä–µ—à–µ–Ω–æ';
                }
            });
        }

        function sendNotification(title, body) {
            if (Notification.permission === 'granted' && document.hidden) {
                new Notification(title, { body, icon: '/favicon.ico' });
            }
        }

        // -------------------- ABLY –ò –ü–†–ò–°–£–¢–°–¢–í–ò–ï --------------------
        function initAbly() {
            if (!currentUser) return;

            ably = new Ably.Realtime({
                key: ABLY_API_KEY,
                clientId: currentUser.id,
                transports: ['web_socket'],
                disconnectedRetryTimeout: 1000,
                suspendedRetryTimeout: 2000,
                realtimeRequestTimeout: 5000
            });

            ably.connection.on('connected', () => {
                console.log('‚úÖ Connected to Ably');

                const presenceChannel = ably.channels.get('presence');
                presenceChannel.presence.enter({
                    name: currentUser.name,
                    avatar: currentUser.avatar || 'üë§',
                    bio: currentUser.bio || '',
                    isAdmin: currentUser.isAdmin,
                    isTester: currentUser.isTester,
                    status: currentUser.status || 'online',
                    hideLastSeen: currentUser.hideLastSeen || false,
                    email: currentUser.email,
                    lastSeen: Date.now()
                });

                presenceChannel.presence.subscribe('enter', (member) => {
                    if (member.clientId !== currentUser.id) {
                        if (member.data.status !== 'invisible') {
                            onlineUsers[member.clientId] = {
                                id: member.clientId,
                                name: member.data.name,
                                avatar: member.data.avatar || 'üë§',
                                bio: member.data.bio || '',
                                online: true,
                                isAdmin: member.data.isAdmin || false,
                                isTester: member.data.isTester || false,
                                status: member.data.status || 'online',
                                hideLastSeen: member.data.hideLastSeen || false,
                                lastSeen: Date.now()
                            };
                        }
                        updateChatsList();
                    }
                });

                presenceChannel.presence.subscribe('update', (member) => {
                    if (member.clientId !== currentUser.id) {
                        if (member.data.status === 'invisible') {
                            delete onlineUsers[member.clientId];
                        } else {
                            onlineUsers[member.clientId] = {
                                id: member.clientId,
                                name: member.data.name,
                                avatar: member.data.avatar || 'üë§',
                                bio: member.data.bio || '',
                                online: true,
                                isAdmin: member.data.isAdmin || false,
                                isTester: member.data.isTester || false,
                                status: member.data.status || 'online',
                                hideLastSeen: member.data.hideLastSeen || false,
                                lastSeen: Date.now()
                            };
                        }
                        updateChatsList();
                    }
                });

                presenceChannel.presence.subscribe('leave', (member) => {
                    if (onlineUsers[member.clientId]) {
                        onlineUsers[member.clientId].online = false;
                        onlineUsers[member.clientId].lastSeen = Date.now();
                        updateChatsList();
                    }
                });

                presenceChannel.presence.get((err, members) => {
                    members.forEach(member => {
                        if (member.clientId !== currentUser.id && member.data.status !== 'invisible') {
                            onlineUsers[member.clientId] = {
                                id: member.clientId,
                                name: member.data.name,
                                avatar: member.data.avatar || 'üë§',
                                bio: member.data.bio || '',
                                online: true,
                                isAdmin: member.data.isAdmin || false,
                                isTester: member.data.isTester || false,
                                status: member.data.status || 'online',
                                hideLastSeen: member.data.hideLastSeen || false,
                                lastSeen: Date.now()
                            };
                        }
                    });
                    updateChatsList();
                });

                const globalChatsChannel = ably.channels.get('global-chats');
                globalChatsChannel.subscribe('new-chat', (message) => {
                    const newChat = message.data;
                    if (!publicChats.find(c => c.id === newChat.id)) {
                        publicChats.push(newChat);
                        localStorage.setItem('publicChats', JSON.stringify(publicChats));
                        updateChatsList();
                    }
                });

                const adminChannel = ably.channels.get('admin-actions');
                adminChannel.subscribe('delete-chat', (message) => {
                    const { chatId } = message.data;
                    publicChats = publicChats.filter(c => c.id !== chatId);
                    localStorage.setItem('publicChats', JSON.stringify(publicChats));
                    myChats = myChats.filter(c => c.id !== chatId);
                    localStorage.setItem(`myChats_${currentUser.id}`, JSON.stringify(myChats));
                    if (messages[chatId]) {
                        delete messages[chatId];
                        localStorage.setItem('messages', JSON.stringify(messages));
                    }
                    if (currentChat && currentChat.id === chatId) {
                        currentChat = null;
                        document.getElementById('messagesContainer').innerHTML = `<div class="chat-deleted-message">${i18n.t('chatDeleted')}</div>`;
                        document.getElementById('currentChatName').innerHTML = i18n.t('chatDeleted');
                        document.getElementById('chatStatus').innerHTML = '';
                        updateUrlWithChat(null);
                    }
                    updateChatsList();
                });

                adminChannel.subscribe('delete-message', (message) => {
                    const { chatId, messageId } = message.data;
                    if (!deletedMessages[chatId]) deletedMessages[chatId] = [];
                    if (!deletedMessages[chatId].includes(messageId)) {
                        deletedMessages[chatId].push(messageId);
                        localStorage.setItem('deletedMessages', JSON.stringify(deletedMessages));
                    }
                    if (messages[chatId]) {
                        messages[chatId] = messages[chatId].filter(m => m.id !== messageId);
                        localStorage.setItem('messages', JSON.stringify(messages));
                        if (currentChat && currentChat.id === chatId) renderMessages();
                        updateChatsList();
                    }
                });

                // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∞–µ—Ç
                const typingChannel = ably.channels.get('typing');
                typingChannel.subscribe((msg) => {
                    if (msg.name === 'typing' && msg.data.chatId === currentChat?.id && msg.data.sender !== currentUser.id) {
                        showTypingIndicator(msg.data.senderName);
                    }
                });

                myChats.forEach(chat => subscribeToChat(chat));
            });

            updateChatsList();
        }

        function subscribeToChat(chat) {
            const chatChannel = ably.channels.get(`chat-${chat.id}`);
            chatChannel.unsubscribe();

            chatChannel.subscribe('message', (message) => {
                const msg = message.data;
                if (deletedMessages[chat.id] && deletedMessages[chat.id].includes(msg.id)) return;
                if (!messages[chat.id]) messages[chat.id] = [];
                const exists = messages[chat.id].some(m => m.id === msg.id);
                if (!exists) {
                    messages[chat.id].push({
                        ...msg,
                        type: msg.sender === currentUser.id ? 'out' : 'in'
                    });
                    messages[chat.id].sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                    updateChatLastMessageTime(chat.id, msg.timestamp);
                    if (currentChat?.id !== chat.id && msg.sender !== currentUser.id) {
                        const recipient = onlineUsers[msg.sender];
                        if (!recipient || recipient.status !== 'dnd') {
                            unreadCounts[chat.id] = (unreadCounts[chat.id] || 0) + 1;
                            localStorage.setItem('unreadCounts', JSON.stringify(unreadCounts));
                        }
                        sendNotification(`–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ ${chat.name}`, msg.text || '–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
                        if (soundEnabled) playNotificationSound();
                    }
                    localStorage.setItem('messages', JSON.stringify(messages));
                    if (currentChat && currentChat.id === chat.id) {
                        renderMessages(true);
                        unreadCounts[chat.id] = 0;
                        localStorage.setItem('unreadCounts', JSON.stringify(unreadCounts));
                    }
                    updateChatsList();
                }
            });

            chatChannel.subscribe('delete', (data) => {
                const { messageId } = data.data;
                if (!deletedMessages[chat.id]) deletedMessages[chat.id] = [];
                if (!deletedMessages[chat.id].includes(messageId)) {
                    deletedMessages[chat.id].push(messageId);
                    localStorage.setItem('deletedMessages', JSON.stringify(deletedMessages));
                }
                if (messages[chat.id]) {
                    messages[chat.id] = messages[chat.id].filter(m => m.id !== messageId);
                    localStorage.setItem('messages', JSON.stringify(messages));
                    if (currentChat?.id === chat.id) renderMessages(true);
                    updateChatsList();
                }
            });

            chatChannel.subscribe('edit', (data) => {
                const { messageId, newText } = data.data;
                if (messages[chat.id]) {
                    const msgIndex = messages[chat.id].findIndex(m => m.id === messageId);
                    if (msgIndex !== -1) {
                        messages[chat.id][msgIndex].text = newText;
                        messages[chat.id][msgIndex].edited = true;
                        localStorage.setItem('messages', JSON.stringify(messages));
                        if (currentChat?.id === chat.id) renderMessages(true);
                    }
                }
            });

            chatChannel.history({ limit: 200 }, (err, resultPage) => {
                if (resultPage && resultPage.items.length > 0) {
                    if (!messages[chat.id]) messages[chat.id] = [];
                    resultPage.items.forEach(item => {
                        const msg = item.data;
                        if (deletedMessages[chat.id] && deletedMessages[chat.id].includes(msg.id)) return;
                        const exists = messages[chat.id].some(m => m.id === msg.id);
                        if (!exists) {
                            messages[chat.id].push({
                                ...msg,
                                type: msg.sender === currentUser.id ? 'out' : 'in'
                            });
                        }
                    });
                    messages[chat.id].sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                    localStorage.setItem('messages', JSON.stringify(messages));
                    if (currentChat?.id === chat.id) {
                        renderMessages(true);
                        unreadCounts[chat.id] = 0;
                        localStorage.setItem('unreadCounts', JSON.stringify(unreadCounts));
                    }
                }
            });
        }

        function updateChatLastMessageTime(chatId, timestamp) {
            const chat = myChats.find(c => c.id === chatId);
            if (chat) {
                chat.lastMessageTime = timestamp || Date.now();
                myChats.sort((a, b) => (b.lastMessageTime || 0) - (a.lastMessageTime || 0));
                localStorage.setItem(`myChats_${currentUser.id}`, JSON.stringify(myChats));
            }
        }

        // -------------------- –ò–ù–î–ò–ö–ê–¢–û–† –ü–ï–ß–ê–¢–ê–ï–¢ --------------------
        function sendTyping() {
            if (!currentChat || !ably) return;
            const typingChannel = ably.channels.get('typing');
            typingChannel.publish('typing', {
                chatId: currentChat.id,
                sender: currentUser.id,
                senderName: currentUser.name
            });
            // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–µ—á–∞—Ç–∏
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                // –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏, –Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã —Å–∫—Ä–æ–µ–º —á–µ—Ä–µ–∑ 2 —Å–µ–∫
            }, 2000);
        }

        function showTypingIndicator(senderName) {
            const indicator = document.getElementById('typingIndicator');
            indicator.textContent = `${senderName} ${i18n.t('typing')}`;
            indicator.style.display = 'block';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 3000);
        }

        // -------------------- –ó–í–£–ö–û–í–´–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø --------------------
        function playNotificationSound() {
            if (!soundEnabled) return;
            const audio = new Audio('data:audio/wav;base64,UklGRlwAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YVoAAACAgICAf39/f39/f3+AgI CAgIB/f39/f39/f4CAgICAf39/f39/f38='); // –∫–æ—Ä–æ—Ç–∫–∏–π –∑–≤—É–∫
            audio.play().catch(e => console.log('Audio play failed', e));
        }

        function toggleSoundNotifications() {
            soundEnabled = !soundEnabled;
            localStorage.setItem('soundEnabled', soundEnabled);
            document.getElementById('soundToggle').className = soundEnabled ? 'toggle-switch active' : 'toggle-switch';
        }

        // -------------------- –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø --------------------
        function login() {
            const now = Date.now();
            if (now - lastLoginAttemptTime > LOGIN_TIMEFRAME) loginAttempts = 0;
            if (loginAttempts >= MAX_LOGIN_ATTEMPTS) {
                alert(i18n.t('tooManyAttempts'));
                return;
            }
            loginAttempts++;
            lastLoginAttemptTime = now;

            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const remember = document.getElementById('rememberMe').checked;

            if (!username || !password) {
                alert(i18n.t('fillAllFields'));
                return;
            }

            const userKey = username.toLowerCase();
            if (users[userKey] && users[userKey].password === password) {
                currentUser = {
                    id: users[userKey].id,
                    name: users[userKey].name,
                    avatar: users[userKey].avatar || 'üë§',
                    bio: users[userKey].bio || '',
                    email: users[userKey].email || '',
                    isAdmin: users[userKey].isAdmin || false,
                    isTester: users[userKey].isTester || false,
                    status: users[userKey].status || 'online',
                    hideLastSeen: users[userKey].hideLastSeen || false,
                    language: users[userKey].language || 'ru',
                    theme: users[userKey].theme || 'dark',
                    hue: users[userKey].hue || 210,
                    saturation: users[userKey].saturation || 80,
                    lightness: users[userKey].lightness || 60,
                    fontSize: users[userKey].fontSize || 'medium',
                    compactMode: users[userKey].compactMode || false,
                    wallpaper: users[userKey].wallpaper || 'default'
                };

                if (remember) localStorage.setItem('currentUser', JSON.stringify(currentUser));

                myChats = JSON.parse(localStorage.getItem(`myChats_${currentUser.id}`)) || [];

                document.getElementById('loginModal').classList.remove('active');
                document.getElementById('appContainer').style.display = 'flex';

                i18n.setLang(currentUser.language);
                document.documentElement.style.setProperty('--hue', currentUser.hue);
                document.documentElement.style.setProperty('--saturation', currentUser.saturation + '%');
                document.documentElement.style.setProperty('--lightness', currentUser.lightness + '%');
                document.getElementById('hideLastSeenToggle').className = currentUser.hideLastSeen ? 'toggle-switch active' : 'toggle-switch';
                setFontSize(currentUser.fontSize);
                if (currentUser.compactMode) document.body.classList.add('compact-mode');
                if (currentUser.wallpaper) setWallpaper(currentUser.wallpaper);

                updateProfileUI();
                initAbly();
                checkUrlForChat();
            } else {
                alert(i18n.t('wrongPassword'));
            }
        }

        function register() {
            const now = Date.now();
            if (now - lastLoginAttemptTime > LOGIN_TIMEFRAME) loginAttempts = 0;
            if (loginAttempts >= MAX_LOGIN_ATTEMPTS) {
                alert(i18n.t('tooManyAttempts'));
                return;
            }
            loginAttempts++;
            lastLoginAttemptTime = now;

            const username = document.getElementById('registerUsername').value.trim();
            const email = document.getElementById('registerEmail').value.trim().toLowerCase();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            const remember = document.getElementById('rememberMeRegister').checked;

            if (!username || !email || !password) {
                alert(i18n.t('fillAllFields'));
                return;
            }
            if (password !== confirmPassword) {
                alert(i18n.t('passwordsDoNotMatch'));
                return;
            }
            if (password.length < 3) {
                alert(i18n.t('passwordTooShort'));
                return;
            }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                alert('Invalid email');
                return;
            }

            const userKey = username.toLowerCase();
            if (users[userKey]) {
                alert(i18n.t('userExists'));
                return;
            }
            for (let key in users) {
                if (users[key].email === email) {
                    alert(i18n.t('emailExists'));
                    return;
                }
            }

            const isAdmin = username === ADMIN_USERNAME;
            const isTester = username === TESTER_USERNAME;
            const newUser = {
                id: 'user_' + Date.now() + Math.random().toString(36).substr(2, 5),
                name: username,
                email: email,
                password: password,
                avatar: 'üë§',
                bio: '',
                status: 'online',
                hideLastSeen: false,
                language: 'ru',
                theme: 'dark',
                hue: 210,
                saturation: 80,
                lightness: 60,
                fontSize: 'medium',
                compactMode: false,
                wallpaper: 'default',
                isAdmin: isAdmin,
                isTester: isTester,
                createdAt: new Date().toISOString()
            };

            users[userKey] = newUser;
            localStorage.setItem('telegram_users', JSON.stringify(users));

            currentUser = {
                id: newUser.id,
                name: newUser.name,
                avatar: newUser.avatar,
                bio: newUser.bio,
                email: newUser.email,
                isAdmin: isAdmin,
                isTester: isTester,
                status: 'online',
                hideLastSeen: false,
                language: 'ru',
                theme: 'dark',
                hue: 210,
                saturation: 80,
                lightness: 60,
                fontSize: 'medium',
                compactMode: false,
                wallpaper: 'default'
            };

            if (remember) localStorage.setItem('currentUser', JSON.stringify(currentUser));

            document.getElementById('loginModal').classList.remove('active');
            document.getElementById('appContainer').style.display = 'flex';

            updateProfileUI();
            initAbly();
        }

        function logout() {
            closeProfileModal();
            if (ably) {
                const presenceChannel = ably.channels.get('presence');
                presenceChannel.presence.leave();
                ably.close();
            }
            localStorage.removeItem('currentUser');
            currentUser = null;
            currentChat = null;
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('loginModal').classList.add('active');
            updateUrlWithChat(null);
        }

        // -------------------- –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–ô --------------------
        function sendMessage() {
            if (sendBtnDisabled) {
                alert(i18n.t('tooManyAttempts'));
                return;
            }

            const input = document.getElementById('messageInput');
            const text = input.value.trim();

            if (!currentChat) {
                alert(i18n.t('selectChat'));
                return;
            }
            if (!text) return;

            disableSendButton();

            // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —á–∞—Ç –µ—Å—Ç—å –≤ myChats
            if (!myChats.find(c => c.id === currentChat.id)) {
                myChats.push(currentChat);
                localStorage.setItem(`myChats_${currentUser.id}`, JSON.stringify(myChats));
                if (ably) subscribeToChat(currentChat);
            }

            const now = new Date();
            const timeString = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
            const messageId = Date.now().toString() + Math.random().toString(36).substr(2, 5);
            const timestamp = Date.now();

            const message = {
                id: messageId,
                chatId: currentChat.id,
                sender: currentUser.id,
                senderName: currentUser.name,
                text: text,
                time: timeString,
                isAdmin: currentUser.isAdmin || false,
                timestamp: timestamp
            };

            if (!messages[currentChat.id]) messages[currentChat.id] = [];
            messages[currentChat.id].push({ ...message, type: 'out' });
            messages[currentChat.id].sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));

            localStorage.setItem('messages', JSON.stringify(messages));

            updateChatLastMessageTime(currentChat.id, timestamp);

            if (ably) {
                const chatChannel = ably.channels.get(`chat-${currentChat.id}`);
                chatChannel.publish('message', message);
            }

            input.value = '';
            input.style.height = 'auto';
            renderMessages(true);
            updateChatsList();
        }

        function disableSendButton() {
            sendBtnDisabled = true;
            document.getElementById('sendBtn').style.opacity = '0.5';
            document.getElementById('sendBtn').style.pointerEvents = 'none';
            setTimeout(() => {
                sendBtnDisabled = false;
                document.getElementById('sendBtn').style.opacity = '1';
                document.getElementById('sendBtn').style.pointerEvents = 'auto';
            }, MESSAGE_COOLDOWN);
        }

        // -------------------- –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–ï –†–ï–ß–ò --------------------
        function initSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert(i18n.t('speechNotSupported'));
                return null;
            }
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const rec = new SpeechRecognition();
            rec.lang = i18n.currentLang === 'ru' ? 'ru-RU' : 'en-US';
            rec.interimResults = true;
            rec.maxAlternatives = 1;
            rec.continuous = true;
            return rec;
        }

        function toggleSpeechRecognition() {
            if (isRecording) {
                stopSpeechRecognition();
                return;
            }
            if (!recognition) {
                recognition = initSpeechRecognition();
                if (!recognition) return;
            }
            recognition.lang = i18n.currentLang === 'ru' ? 'ru-RU' : 'en-US';
            recognition.onstart = () => {
                isRecording = true;
                document.getElementById('micBtn').classList.add('recording');
                document.getElementById('micBtn').textContent = '‚èπÔ∏è';
            };
            recognition.onresult = (event) => {
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    }
                }
                if (finalTranscript) {
                    const input = document.getElementById('messageInput');
                    input.value += (input.value ? ' ' : '') + finalTranscript;
                }
            };
            recognition.onerror = (event) => {
                console.error('Speech recognition error', event.error);
                if (event.error !== 'no-speech') {
                    alert(i18n.t('microphoneError'));
                }
                stopSpeechRecognition();
            };
            recognition.onend = () => {
                if (isRecording) {
                    recognition.start();
                } else {
                    stopSpeechRecognition();
                }
            };
            recognition.start();
        }

        function stopSpeechRecognition() {
            if (recognition) {
                recognition.stop();
            }
            isRecording = false;
            document.getElementById('micBtn').classList.remove('recording');
            document.getElementById('micBtn').textContent = 'üé§';
        }

        // -------------------- –†–ï–ù–î–ï–† –°–û–û–ë–©–ï–ù–ò–ô --------------------
        function renderMessages(animate = true) {
            const container = document.getElementById('messagesContainer');
            if (!container) return;

            const oldScrollHeight = container.scrollHeight;
            const oldScrollTop = container.scrollTop;
            const isAtBottom = oldScrollHeight - oldScrollTop - container.clientHeight < 50;

            container.innerHTML = '';

            if (!currentChat) {
                container.innerHTML = `<div style="text-align: center; color: var(--text-secondary); padding: 40px;">${i18n.t('selectChat')}</div>`;
                return;
            }

            if (!messages[currentChat.id] || messages[currentChat.id].length === 0) {
                container.innerHTML = `<div style="text-align: center; color: var(--text-secondary); padding: 40px;">${i18n.t('noMessages')}</div>`;
                return;
            }

            messages[currentChat.id].sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));

            messages[currentChat.id].forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.type}`;
                if (!animate) messageDiv.style.animation = 'none';
                messageDiv.setAttribute('data-id', msg.id);

                let content = '';
                if (msg.text) {
                    content = `<div class="message-bubble">${escapeHtml(msg.text)}${msg.edited ? ' <span style="font-size: 10px; opacity: 0.7;">(' + i18n.t('edit') + ')</span>' : ''}</div>`;
                }

                let actions = '';
                if (msg.sender === currentUser.id || currentUser.isAdmin) {
                    actions = `
                        <div class="message-actions">
                            ${msg.sender === currentUser.id ? `<button class="message-action-btn" onclick="editMessage('${msg.id}', event)">‚úèÔ∏è</button>` : ''}
                            <button class="message-action-btn" onclick="deleteMessage('${msg.id}', event)">üóëÔ∏è</button>
                        </div>
                    `;
                }

                let badges = '';
                if (msg.isAdmin && msg.senderName === ADMIN_USERNAME) {
                    badges = '<span class="admin-badge">–°–æ–∑–¥–∞—Ç–µ–ª—å</span>';
                } else if (msg.senderName === TESTER_USERNAME) {
                    badges = '<span class="tester-badge">–¢–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫</span>';
                }

                let senderHtml = '';
                if (msg.type === 'in') {
                    const senderUser = users[msg.sender] || { avatar: 'üë§' };
                    senderHtml = `
                        <div class="message-sender" onclick="openUserProfile('${msg.sender}')">
                            <span class="chat-avatar" style="width: 20px; height: 20px; font-size: 14px; display: inline-block; margin-right: 4px;">${senderUser.avatar || 'üë§'}</span>
                            ${escapeHtml(msg.senderName)} ${badges}
                        </div>
                    `;
                }

                messageDiv.innerHTML = `
                    ${actions}
                    ${senderHtml}
                    ${content}
                    <div class="message-time">${msg.time}</div>
                `;

                container.appendChild(messageDiv);
            });

            if (isAtBottom) {
                container.scrollTo({
                    top: container.scrollHeight,
                    behavior: animate ? 'smooth' : 'auto'
                });
            }
        }

        // -------------------- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ß–ê–¢–ê–ú–ò –ò –°–ü–ò–°–ö–ê–ú–ò --------------------
        function updateChatsList() {
            const list = document.getElementById('chatsList');
            if (!list) return;

            list.innerHTML = '';

            let items = [];

            if (currentTab === 'chats') {
                items = [...myChats];
            } else if (currentTab === 'public') {
                items = [...publicChats];
            }

            const allUsers = Object.values(users).map(u => ({
                id: u.id,
                name: u.name,
                avatar: u.avatar,
                bio: u.bio,
                isAdmin: u.isAdmin,
                isTester: u.isTester,
                status: u.status,
                hideLastSeen: u.hideLastSeen,
                lastSeen: u.lastSeen,
                online: onlineUsers[u.id] ? onlineUsers[u.id].online : false,
                isUser: true
            }));

            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            if (searchTerm) {
                const filteredChats = items.filter(item => 
                    (item.name || '').toLowerCase().includes(searchTerm) ||
                    (item.description || '').toLowerCase().includes(searchTerm)
                );
                const filteredUsers = allUsers.filter(u => 
                    u.name.toLowerCase().includes(searchTerm) || 
                    (u.bio || '').toLowerCase().includes(searchTerm)
                );
                items = [...filteredChats, ...filteredUsers];
            }

            items.sort((a, b) => {
                if (a.isUser && !b.isUser) return 1;
                if (!a.isUser && b.isUser) return -1;
                if (!a.isUser && !b.isUser) return (b.lastMessageTime || 0) - (a.lastMessageTime || 0);
                return (a.name || '').localeCompare(b.name || '');
            });

            if (items.length === 0) {
                list.innerHTML = `<div style="padding: 20px; text-align: center; color: var(--text-secondary);">${i18n.t('nothingFound')}</div>`;
                return;
            }

            items.forEach(item => {
                const element = document.createElement('div');
                element.className = `chat-item ${currentChat?.id === item.id ? 'active' : ''}`;

                if (item.isUser) {
                    element.onclick = () => createPrivateChat(item);
                    const lastSeenText = formatLastSeen(item.lastSeen, item.online, item.hideLastSeen);
                    let badges = '';
                    if (item.isAdmin) badges = '<span class="admin-badge">–°–æ–∑–¥–∞—Ç–µ–ª—å</span>';
                    else if (item.isTester) badges = '<span class="tester-badge">–¢–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫</span>';
                    element.innerHTML = `
                        <div class="chat-avatar">${item.avatar || 'üë§'}</div>
                        <div class="chat-details">
                            <div class="chat-name">
                                ${escapeHtml(item.name)} ${badges}
                                ${item.online ? '<span class="online-indicator"></span>' : ''}
                                ${item.status === 'dnd' ? '<span class="dnd-badge">DND</span>' : ''}
                            </div>
                            <div class="chat-last-message">${escapeHtml(item.bio || i18n.t('noBio'))} ‚Ä¢ ${lastSeenText}</div>
                        </div>
                    `;
                } else {
                    const lastMsg = messages[item.id] && messages[item.id].length > 0 ? messages[item.id][messages[item.id].length - 1] : null;
                    const unread = unreadCounts[item.id] || 0;

                    element.onclick = () => joinChat(item);

                    let chatNameHTML = `${escapeHtml(item.name || i18n.t('noName'))} ${item.password ? '<span class="lock-icon">üîí</span>' : ''}`;

                    element.innerHTML = `
                        <div class="chat-avatar">${(item.name || '?').charAt(0)}</div>
                        <div class="chat-details">
                            <div class="chat-name">
                                ${chatNameHTML}
                            </div>
                            <div class="chat-last-message">
                                ${lastMsg ? (lastMsg.text ? escapeHtml(lastMsg.text) : i18n.t('noMessages')) : (escapeHtml(item.description || i18n.t('noMessages')))}
                            </div>
                        </div>
                        <div class="chat-meta">
                            <div class="chat-time">${lastMsg ? lastMsg.time : ''}</div>
                            ${unread > 0 ? `<div class="chat-unread">${unread}</div>` : ''}
                        </div>
                    `;
                }

                list.appendChild(element);
            });
        }

        function formatLastSeen(timestamp, isOnline, hideLastSeen) {
            if (isOnline) return i18n.t('onlineNow');
            if (hideLastSeen) return i18n.t('recently');
            if (!timestamp) return i18n.t('offline');
            const diff = Date.now() - timestamp;
            const minutes = Math.floor(diff / 60000);
            if (minutes < 1) return i18n.t('justNow');
            if (minutes < 60) return `${minutes} ${i18n.t('minutesAgo')}`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} ${i18n.t('hoursAgo')}`;
            const days = Math.floor(hours / 24);
            return `${days} ${i18n.t('daysAgo')}`;
        }

        function joinChat(chat) {
            if (!chat) return;

            if (chat.password && (!chat.members || !chat.members.includes(currentUser.id))) {
                pendingChatToJoin = chat;
                document.getElementById('joinChatTitle').textContent = i18n.t('enterPassword') + ` "${chat.name}"`;
                document.getElementById('joinChatModal').classList.add('active');
                return;
            }

            if (!chat.members) chat.members = [];
            if (!chat.members.includes(currentUser.id)) chat.members.push(currentUser.id);

            if (!myChats.find(c => c.id === chat.id)) {
                myChats.push(chat);
                localStorage.setItem(`myChats_${currentUser.id}`, JSON.stringify(myChats));
                if (ably) subscribeToChat(chat);
            }

            currentChat = chat;
            updateUrlWithChat(chat);

            document.getElementById('currentChatName').innerHTML = escapeHtml(chat.name) + (chat.password ? ' üîí' : '');
            document.getElementById('chatStatus').textContent = chat.description || '';

            if (!messages[chat.id]) messages[chat.id] = [];
            messages[chat.id].sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));

            unreadCounts[chat.id] = 0;
            localStorage.setItem('unreadCounts', JSON.stringify(unreadCounts));

            renderMessages(true);
            updateChatsList();

            if (window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('active');
        }

        function createPrivateChat(user) {
            // ID –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —á–∞—Ç–∞ = –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            const chatId = [currentUser.id, user.id].sort().join('-');
            let privateChat = myChats.find(c => c.id === chatId);
            if (!privateChat) {
                privateChat = {
                    id: chatId,
                    name: user.name,
                    isPrivate: true,
                    user: user,
                    members: [currentUser.id, user.id]
                };
                myChats.push(privateChat);
                localStorage.setItem(`myChats_${currentUser.id}`, JSON.stringify(myChats));
                if (ably) subscribeToChat(privateChat);
            }
            joinChat(privateChat);
        }

        function deleteChat(chatId, event) {
            if (event) event.stopPropagation();
            const chat = publicChats.find(c => c.id === chatId) || myChats.find(c => c.id === chatId);
            if (!chat) return;
            if (!currentUser.isAdmin && chat.createdBy !== currentUser.id) {
                alert(i18n.t('noPermission'));
                return;
            }
            if (!confirm(i18n.t('areYouSure'))) return;

            publicChats = publicChats.filter(c => c.id !== chatId);
            localStorage.setItem('publicChats', JSON.stringify(publicChats));
            myChats = myChats.filter(c => c.id !== chatId);
            localStorage.setItem(`myChats_${currentUser.id}`, JSON.stringify(myChats));
            if (messages[chatId]) {
                delete messages[chatId];
                localStorage.setItem('messages', JSON.stringify(messages));
            }
            if (ably) {
                const adminChannel = ably.channels.get('admin-actions');
                adminChannel.publish('delete-chat', { chatId, deletedBy: currentUser.id });
            }
            if (currentChat && currentChat.id === chatId) {
                currentChat = null;
                document.getElementById('messagesContainer').innerHTML = `<div class="chat-deleted-message">${i18n.t('chatDeleted')}</div>`;
                document.getElementById('currentChatName').innerHTML = i18n.t('chatDeleted');
                document.getElementById('chatStatus').innerHTML = '';
                updateUrlWithChat(null);
            }
            updateChatsList();
        }

        function deleteCurrentChat() {
            if (currentChat) {
                deleteChat(currentChat.id);
                closeChatInfoModal();
            }
        }

        function joinProtectedChat() {
            const password = document.getElementById('joinPasswordInput').value;
            if (pendingChatToJoin && password === pendingChatToJoin.password) {
                if (!pendingChatToJoin.members) pendingChatToJoin.members = [];
                pendingChatToJoin.members.push(currentUser.id);
                joinChat(pendingChatToJoin);
                closeJoinChatModal();
            } else {
                alert(i18n.t('wrongPassword'));
            }
        }

        function createPublicChat() {
            const name = document.getElementById('chatNameInput').value.trim();
            const info = document.getElementById('chatInfoInput').value.trim();
            const password = document.getElementById('chatPasswordInput').value.trim();
            if (!name) {
                alert(i18n.t('fillAllFields'));
                return;
            }
            const newChat = {
                id: 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 8),
                name: name,
                description: info || '',
                info: info || '',
                password: password || null,
                createdBy: currentUser.id,
                createdByName: currentUser.name,
                members: [currentUser.id],
                createdAt: new Date().toISOString()
            };
            publicChats.push(newChat);
            localStorage.setItem('publicChats', JSON.stringify(publicChats));
            if (ably) {
                const globalChatsChannel = ably.channels.get('global-chats');
                globalChatsChannel.publish('new-chat', newChat);
            }
            joinChat(newChat);
            closeCreateChatModal();
        }

        // -------------------- –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï/–£–î–ê–õ–ï–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–ô --------------------
        function deleteMessage(messageId, event) {
            if (event) { event.stopPropagation(); event.preventDefault(); }
            if (!currentChat) return;
            const msg = messages[currentChat.id].find(m => m.id === messageId);
            if (!currentUser.isAdmin && msg.sender !== currentUser.id) {
                alert(i18n.t('noPermission'));
                return;
            }
            if (!confirm(i18n.t('areYouSure'))) return;

            if (!deletedMessages[currentChat.id]) deletedMessages[currentChat.id] = [];
            if (!deletedMessages[currentChat.id].includes(messageId)) {
                deletedMessages[currentChat.id].push(messageId);
                localStorage.setItem('deletedMessages', JSON.stringify(deletedMessages));
            }

            messages[currentChat.id] = messages[currentChat.id].filter(m => m.id !== messageId);
            localStorage.setItem('messages', JSON.stringify(messages));

            if (ably) {
                const chatChannel = ably.channels.get(`chat-${currentChat.id}`);
                chatChannel.publish('delete', { messageId, senderId: currentUser.id, timestamp: Date.now() });
                if (currentUser.isAdmin) {
                    const adminChannel = ably.channels.get('admin-actions');
                    adminChannel.publish('delete-message', { chatId: currentChat.id, messageId, timestamp: Date.now() });
                }
            }

            renderMessages(true);
            updateChatsList();
        }

        function editMessage(messageId, event) {
            if (event) { event.stopPropagation(); event.preventDefault(); }
            if (!currentChat) return;
            const msg = messages[currentChat.id].find(m => m.id === messageId);
            if (msg && msg.sender === currentUser.id) {
                messageToEdit = msg;
                document.getElementById('editMessageText').value = msg.text || '';
                document.getElementById('editMessageModal').classList.add('active');
            } else {
                alert(i18n.t('noPermission'));
            }
        }

        function saveEditedMessage() {
            const newText = document.getElementById('editMessageText').value.trim();
            if (!newText || !messageToEdit || !currentChat) return;

            const msgIndex = messages[currentChat.id].findIndex(m => m.id === messageToEdit.id);
            if (msgIndex !== -1) {
                messages[currentChat.id][msgIndex].text = newText;
                messages[currentChat.id][msgIndex].edited = true;
                localStorage.setItem('messages', JSON.stringify(messages));

                if (ably) {
                    const chatChannel = ably.channels.get(`chat-${currentChat.id}`);
                    chatChannel.publish('edit', { messageId: messageToEdit.id, newText, timestamp: Date.now() });
                }

                renderMessages(true);
                closeEditMessageModal();
            }
        }

        // -------------------- –ü–†–û–§–ò–õ–¨ –ò –ê–í–ê–¢–ê–† --------------------
        function openProfileModal() {
            document.getElementById('profileNameInput').value = currentUser.name;
            document.getElementById('profileEmailInput').value = currentUser.email || '';
            document.getElementById('profileBioInput').value = currentUser.bio || '';
            const radios = document.querySelectorAll('input[name="status"]');
            for (let r of radios) {
                if (r.value === currentUser.status) r.checked = true;
            }
            document.getElementById('profileAvatarLarge').textContent = currentUser.avatar || 'üë§';
            document.getElementById('profileModal').classList.add('active');
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('active');
        }

        function changeStatus(value) {
            currentUser.status = value;
        }

        function saveProfile() {
            const newName = document.getElementById('profileNameInput').value.trim();
            const newBio = document.getElementById('profileBioInput').value.trim();

            if (newName && newName !== currentUser.name) {
                const oldKey = currentUser.name.toLowerCase();
                const newKey = newName.toLowerCase();

                if (users[newKey] && newKey !== oldKey) {
                    alert(i18n.t('userExists'));
                    return;
                }

                if (users[oldKey]) {
                    users[oldKey].name = newName;
                    if (newKey !== oldKey) {
                        users[newKey] = users[oldKey];
                        delete users[oldKey];
                    }
                }
                currentUser.name = newName;
            }

            if (newBio !== currentUser.bio) {
                currentUser.bio = newBio;
                const userKey = currentUser.name.toLowerCase();
                if (users[userKey]) users[userKey].bio = newBio;
            }

            if (currentUser.status) {
                const userKey = currentUser.name.toLowerCase();
                if (users[userKey]) users[userKey].status = currentUser.status;
                if (ably) {
                    const presenceChannel = ably.channels.get('presence');
                    presenceChannel.presence.update({
                        name: currentUser.name,
                        avatar: currentUser.avatar,
                        bio: currentUser.bio,
                        isAdmin: currentUser.isAdmin,
                        isTester: currentUser.isTester,
                        status: currentUser.status,
                        hideLastSeen: currentUser.hideLastSeen,
                        email: currentUser.email
                    });
                }
            }

            localStorage.setItem('telegram_users', JSON.stringify(users));
            localStorage.setItem('currentUser', JSON.stringify(currentUser));

            updateProfileUI();
            closeProfileModal();
        }

        function openAvatarModal() {
            const grid = document.getElementById('avatarGrid');
            grid.innerHTML = '';
            weirdEmojis.forEach(emoji => {
                const div = document.createElement('div');
                div.className = 'avatar-option';
                div.textContent = emoji;
                div.onclick = () => selectAvatar(emoji, div);
                if (currentUser.avatar === emoji) div.classList.add('selected');
                grid.appendChild(div);
            });
            document.getElementById('avatarModal').classList.add('active');
        }

        let selectedAvatar = null;
        function selectAvatar(emoji, element) {
            document.querySelectorAll('.avatar-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            selectedAvatar = emoji;
        }

        function saveAvatar() {
            if (selectedAvatar) {
                currentUser.avatar = selectedAvatar;
                const userKey = currentUser.name.toLowerCase();
                if (users[userKey]) users[userKey].avatar = selectedAvatar;
                localStorage.setItem('telegram_users', JSON.stringify(users));
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                updateProfileUI();
                if (ably) {
                    const presenceChannel = ably.channels.get('presence');
                    presenceChannel.presence.update({
                        name: currentUser.name,
                        avatar: selectedAvatar,
                        bio: currentUser.bio,
                        isAdmin: currentUser.isAdmin,
                        isTester: currentUser.isTester,
                        status: currentUser.status,
                        hideLastSeen: currentUser.hideLastSeen,
                        email: currentUser.email
                    });
                }
            }
            closeAvatarModal();
        }

        function closeAvatarModal() {
            document.getElementById('avatarModal').classList.remove('active');
            selectedAvatar = null;
        }

        // -------------------- –ü–†–û–°–ú–û–¢–† –ü–†–û–§–ò–õ–Ø –°–û–ë–ï–°–ï–î–ù–ò–ö–ê --------------------
        function openUserProfile(userId) {
            const user = onlineUsers[userId] || users[userId] || null;
            if (!user) return;
            const view = document.getElementById('userProfileView');
            const lastSeenText = formatLastSeen(user.lastSeen, user.online, user.hideLastSeen);
            const statusText = user.status === 'dnd' ? i18n.t('dndStatus') : (user.online ? i18n.t('onlineNow') : lastSeenText);
            let badges = '';
            if (user.isAdmin) badges = '<span class="admin-badge">–°–æ–∑–¥–∞—Ç–µ–ª—å</span>';
            else if (user.isTester) badges = '<span class="tester-badge">–¢–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫</span>';
            view.innerHTML = `
                <div class="avatar-large">${user.avatar || 'üë§'}</div>
                <div class="name">${escapeHtml(user.name)} ${badges}</div>
                <div class="bio">${escapeHtml(user.bio || i18n.t('noBio'))}</div>
                <div class="status">${statusText}</div>
            `;
            document.getElementById('userProfileModal').classList.add('active');
        }

        function closeUserProfileModal() {
            document.getElementById('userProfileModal').classList.remove('active');
        }

        // -------------------- –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ß–ê–¢–ï --------------------
        function openChatInfoModal() {
            if (!currentChat) return;
            const modal = document.getElementById('chatInfoModal');
            document.getElementById('chatInfoName').innerHTML = escapeHtml(currentChat.name) + (currentChat.password ? ' üîí' : '');
            const details = document.getElementById('chatInfoDetails');
            const creator = users[currentChat.createdBy] || { name: currentChat.createdByName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' };
            const membersCount = currentChat.members ? currentChat.members.length : 1;
            details.innerHTML = `
                <div><strong>${i18n.t('createdBy')}:</strong> ${escapeHtml(creator.name)}</div>
                <div><strong>${i18n.t('description')}:</strong> ${escapeHtml(currentChat.info || currentChat.description || '')}</div>
                <div><strong>${i18n.t('members')}:</strong> ${membersCount}</div>
            `;
            const deleteBtn = document.getElementById('deleteChatBtn');
            if (currentUser.isAdmin || currentChat.createdBy === currentUser.id) {
                deleteBtn.style.display = 'block';
            } else {
                deleteBtn.style.display = 'none';
            }
            modal.classList.add('active');
        }

        function closeChatInfoModal() {
            document.getElementById('chatInfoModal').classList.remove('active');
        }

        // -------------------- –ù–ê–°–¢–†–û–ô–ö–ò --------------------
        function openSettingsModal() {
            document.getElementById('hideLastSeenToggle').className = currentUser.hideLastSeen ? 'toggle-switch active' : 'toggle-switch';
            document.getElementById('currentLanguage').textContent = currentUser.language === 'ru' ? '–†—É—Å—Å–∫–∏–π' : 'English';
            document.getElementById('compactModeToggle').className = currentUser.compactMode ? 'toggle-switch active' : 'toggle-switch';
            document.getElementById('soundToggle').className = soundEnabled ? 'toggle-switch active' : 'toggle-switch';
            // –û—Ç–º–µ—Ç–∏–º —Ä–∞–¥–∏–æ –¥–ª—è —à—Ä–∏—Ñ—Ç–∞
            const fontSizeRadios = document.querySelectorAll('input[name="fontSize"]');
            for (let r of fontSizeRadios) {
                if (r.value === currentUser.fontSize) r.checked = true;
            }
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function toggleHideLastSeen() {
            currentUser.hideLastSeen = !currentUser.hideLastSeen;
            document.getElementById('hideLastSeenToggle').className = currentUser.hideLastSeen ? 'toggle-switch active' : 'toggle-switch';
            const userKey = currentUser.name.toLowerCase();
            if (users[userKey]) users[userKey].hideLastSeen = currentUser.hideLastSeen;
            localStorage.setItem('telegram_users', JSON.stringify(users));
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            if (ably) {
                const presenceChannel = ably.channels.get('presence');
                presenceChannel.presence.update({
                    name: currentUser.name,
                    avatar: currentUser.avatar,
                    bio: currentUser.bio,
                    isAdmin: currentUser.isAdmin,
                    isTester: currentUser.isTester,
                    status: currentUser.status,
                    hideLastSeen: currentUser.hideLastSeen,
                    email: currentUser.email
                });
            }
        }

        function setFontSize(size) {
            document.body.classList.remove('font-small', 'font-medium', 'font-large');
            document.body.classList.add(`font-${size}`);
            currentUser.fontSize = size;
            const userKey = currentUser.name.toLowerCase();
            if (users[userKey]) users[userKey].fontSize = size;
            localStorage.setItem('telegram_users', JSON.stringify(users));
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
        }

        function toggleCompactMode() {
            currentUser.compactMode = !currentUser.compactMode;
            document.body.classList.toggle('compact-mode', currentUser.compactMode);
            document.getElementById('compactModeToggle').className = currentUser.compactMode ? 'toggle-switch active' : 'toggle-switch';
            const userKey = currentUser.name.toLowerCase();
            if (users[userKey]) users[userKey].compactMode = currentUser.compactMode;
            localStorage.setItem('telegram_users', JSON.stringify(users));
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
        }

        function setWallpaper(type) {
            document.body.classList.remove('wallpaper-default', 'wallpaper-gradient1', 'wallpaper-gradient2', 'wallpaper-gradient3');
            document.body.classList.add(`wallpaper-${type}`);
            currentUser.wallpaper = type;
            const userKey = currentUser.name.toLowerCase();
            if (users[userKey]) users[userKey].wallpaper = type;
            localStorage.setItem('telegram_users', JSON.stringify(users));
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            // –í–∏–∑—É–∞–ª—å–Ω–æ –æ—Ç–º–µ—Ç–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
            document.querySelectorAll('.wallpaper-preview').forEach(el => el.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        function openLanguageModal() {
            document.getElementById('languageModal').classList.add('active');
            document.getElementById('langRu').className = currentUser.language === 'ru' ? 'lang-btn active' : 'lang-btn';
            document.getElementById('langEn').className = currentUser.language === 'en' ? 'lang-btn active' : 'lang-btn';
        }

        function closeLanguageModal() {
            document.getElementById('languageModal').classList.remove('active');
        }

        function setLanguage(lang) {
            currentUser.language = lang;
            const userKey = currentUser.name.toLowerCase();
            if (users[userKey]) users[userKey].language = lang;
            localStorage.setItem('telegram_users', JSON.stringify(users));
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            i18n.setLang(lang);
            closeLanguageModal();
            updateChatsList();
            renderMessages();
        }

        function openThemeModal() {
            document.getElementById('hueSlider').value = currentUser.hue || 210;
            document.getElementById('saturationSlider').value = currentUser.saturation || 80;
            document.getElementById('lightnessSlider').value = currentUser.lightness || 60;
            document.getElementById('themeModal').classList.add('active');
        }

        function closeThemeModal() {
            document.getElementById('themeModal').classList.remove('active');
        }

        function updateThemeFromSliders() {
            const hue = document.getElementById('hueSlider').value;
            const sat = document.getElementById('saturationSlider').value;
            const light = document.getElementById('lightnessSlider').value;
            document.documentElement.style.setProperty('--hue', hue);
            document.documentElement.style.setProperty('--saturation', sat + '%');
            document.documentElement.style.setProperty('--lightness', light + '%');
        }

        function saveTheme() {
            currentUser.hue = parseInt(document.getElementById('hueSlider').value);
            currentUser.saturation = parseInt(document.getElementById('saturationSlider').value);
            currentUser.lightness = parseInt(document.getElementById('lightnessSlider').value);
            const userKey = currentUser.name.toLowerCase();
            if (users[userKey]) {
                users[userKey].hue = currentUser.hue;
                users[userKey].saturation = currentUser.saturation;
                users[userKey].lightness = currentUser.lightness;
            }
            localStorage.setItem('telegram_users', JSON.stringify(users));
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            closeThemeModal();
        }

        // -------------------- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò --------------------
        function switchAuthMode(mode) {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const loginTab = document.getElementById('loginTabBtn');
            const registerTab = document.getElementById('registerTabBtn');
            if (mode === 'login') {
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                loginTab.className = 'auth-tab active';
                registerTab.className = 'auth-tab';
            } else {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
                loginTab.className = 'auth-tab';
                registerTab.className = 'auth-tab active';
            }
        }

        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('tabChats').className = tab === 'chats' ? 'tab active' : 'tab';
            document.getElementById('tabPublic').className = tab === 'public' ? 'tab active' : 'tab';
            document.getElementById('searchInput').value = '';
            updateChatsList();
        }

        function handleSearch() {
            updateChatsList();
        }

        function openCreateChatModal() {
            document.getElementById('createChatModal').classList.add('active');
        }

        function closeCreateChatModal() {
            document.getElementById('createChatModal').classList.remove('active');
            document.getElementById('chatNameInput').value = '';
            document.getElementById('chatInfoInput').value = '';
            document.getElementById('chatPasswordInput').value = '';
        }

        function closeJoinChatModal() {
            document.getElementById('joinChatModal').classList.remove('active');
            document.getElementById('joinPasswordInput').value = '';
            pendingChatToJoin = null;
        }

        function closeEditMessageModal() {
            document.getElementById('editMessageModal').classList.remove('active');
            document.getElementById('editMessageText').value = '';
            messageToEdit = null;
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function toggleEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            picker.style.display = picker.style.display === 'none' ? 'flex' : 'none';
        }

        function addEmoji(emoji) {
            const input = document.getElementById('messageInput');
            const start = input.selectionStart;
            const end = input.selectionEnd;
            input.value = input.value.substring(0, start) + emoji + input.value.substring(end);
            input.focus();
            input.selectionStart = input.selectionEnd = start + emoji.length;
            input.style.height = 'auto';
            input.style.height = input.scrollHeight + 'px';
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        function updateUrlWithChat(chat) {
            if (chat) {
                const newUrl = `${window.location.pathname}#${chat.id}`;
                window.history.pushState({ chatId: chat.id }, chat.name, newUrl);
                document.title = `${chat.name} - Telegram Web`;
            } else {
                const newUrl = window.location.pathname;
                window.history.pushState({}, 'Telegram Web', newUrl);
                document.title = 'Telegram Web';
            }
        }

        function checkUrlForChat() {
            const hash = window.location.hash.substring(1);
            if (hash) {
                const chat = myChats.find(c => c.id === hash) || publicChats.find(c => c.id === hash);
                if (chat) setTimeout(() => joinChat(chat), 500);
            }
        }

        function populateEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            picker.innerHTML = '';
            emojiList.forEach(emoji => {
                const btn = document.createElement('button');
                btn.className = 'emoji-btn';
                btn.textContent = emoji;
                btn.onclick = () => addEmoji(emoji);
                picker.appendChild(btn);
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            populateEmojiPicker();
            checkSavedSession();
        });

        document.getElementById('messageInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) document.getElementById('sidebar').classList.remove('active');
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeChatInfoModal();
                closeSettingsModal();
                closeLanguageModal();
                closeThemeModal();
                closeUserProfileModal();
                closeEditMessageModal();
                closeJoinChatModal();
                closeCreateChatModal();
                closeAvatarModal();
                closeProfileModal();
            }
        });

        document.addEventListener('click', function(e) {
            const emojiPicker = document.getElementById('emojiPicker');
            const emojiBtn = document.querySelector('.emoji-toggle-btn');
            if (emojiPicker && emojiPicker.style.display === 'flex' && !emojiPicker.contains(e.target) && !emojiBtn.contains(e.target)) {
                emojiPicker.style.display = 'none';
            }
        });
    </script>
</body>
</html>
