<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NewTok</title>
<style>
body {
    margin: 0;
    background: black;
    color: white;
    font-family: Arial;
}
.hidden { display:none }
button,input {
    width:100%;
    padding:10px;
    margin:5px 0;
}
button { background:#ff0050; border:none; color:white }
#feed { height:100vh }
.video video { width:100%; height:100vh; object-fit:cover }
.nav {
    position:fixed; bottom:0; width:100%;
    display:flex; justify-content:space-around;
    background:#111; padding:10px;
}
.panel {
    padding:15px;
}
.chat {
    border-bottom:1px solid #333;
    padding:10px;
    cursor:pointer;
}
.message {
    margin:5px 0;
}
.admin-item {
    border-bottom:1px solid #444;
    padding:8px;
}
</style>
</head>
<body>

<div id="auth">
    <input id="login" placeholder="Ник">
    <input id="password" type="password" placeholder="Пароль">
    <button onclick="loginUser()">Войти</button>
    <hr>
    <input id="rlogin" placeholder="Ник">
    <input id="rpass" type="password" placeholder="Пароль">
    <button onclick="register()">Регистрация</button>
</div>

<div id="feed" class="hidden"></div>

<div id="direct" class="panel hidden"></div>
<div id="chat" class="panel hidden"></div>
<div id="admin" class="panel hidden"></div>

<div class="nav hidden" id="nav">
    <button onclick="showFeed()">Лента</button>
    <button onclick="uploadVideo()">+</button>
    <button onclick="showDirect()">Direct</button>
    <button onclick="showProfile()">Профиль</button>
</div>

<script>
let users = JSON.parse(localStorage.getItem("users"))||{};
let videos = JSON.parse(localStorage.getItem("videos"))||[];
let chats = JSON.parse(localStorage.getItem("chats"))||{};
let currentUser = localStorage.getItem("currentUser");
let index = 0;

// admin
if(!users["martin_mefik"]) {
    users["martin_mefik"]={password:"martin_mefik1234",role:"admin"};
    save();
}

function save(){
    localStorage.setItem("users",JSON.stringify(users));
    localStorage.setItem("videos",JSON.stringify(videos));
    localStorage.setItem("chats",JSON.stringify(chats));
}

function loginUser(){
    if(users[login.value]?.password===password.value){
        currentUser=login.value;
        localStorage.setItem("currentUser",currentUser);
        start();
    } else alert("Ошибка");
}

function register(){
    if(users[rlogin.value]) return alert("Ник занят");
    users[rlogin.value]={password:rpass.value,role:"user"};
    save(); alert("Создано");
}

function start(){
    auth.classList.add("hidden");
    feed.classList.remove("hidden");
    nav.classList.remove("hidden");
    showFeed();
}

function showFeed(){
    hideAll();
    feed.classList.remove("hidden");
    feed.innerHTML="";
    if(!videos[index]) index=0;
    let v=videos[index];
    if(!v) return;
    feed.innerHTML=`
    <div class="video">
        <video src="${v.src}" autoplay loop muted></video>
        <div>@${v.user}</div>
    </div>`;
}

function uploadVideo(){
    let i=document.createElement("input");
    i.type="file"; i.accept="video/*";
    i.onchange=e=>{
        let url=URL.createObjectURL(e.target.files[0]);
        videos.push({id:Date.now(),user:currentUser,src:url});
        save(); showFeed();
    };
    i.click();
}

// SWIPE
let sy=0;
document.addEventListener("touchstart",e=>sy=e.touches[0].clientY);
document.addEventListener("touchend",e=>{
    if(sy-e.changedTouches[0].clientY>50){
        index++; showFeed();
    }
});

// DIRECT
function showDirect(){
    hideAll();
    direct.classList.remove("hidden");
    direct.innerHTML="<h3>Чаты</h3>";
    Object.keys(chats).forEach(k=>{
        if(k.includes(currentUser)){
            let u=k.replace(currentUser,"").replace("_","");
            direct.innerHTML+=`<div class="chat" onclick="openChat('${u}')">${u}</div>`;
        }
    });
    direct.innerHTML+=`
    <input id="newChat" placeholder="Написать пользователю">
    <button onclick="openChat(newChat.value)">Открыть</button>`;
}

function openChat(user){
    if(!users[user]) return alert("Нет пользователя");
    hideAll();
    chat.classList.remove("hidden");
    let key=[currentUser,user].sort().join("_");
    chats[key]=chats[key]||[];
    chat.innerHTML=`<h3>${user}</h3>`;
    chats[key].forEach(m=>{
        chat.innerHTML+=`<div class="message"><b>${m.from}:</b> ${m.text}</div>`;
    });
    chat.innerHTML+=`
    <input id="msg">
    <button onclick="sendMsg('${key}','${user}')">Отправить</button>`;
}

function sendMsg(key,user){
    chats[key].push({from:currentUser,text:msg.value});
    save(); openChat(user);
}

// PROFILE / ADMIN
function showProfile(){
    if(users[currentUser].role==="admin") showAdmin();
    else alert("Пользователь: "+currentUser);
}

function showAdmin(){
    hideAll();
    admin.classList.remove("hidden");
    admin.innerHTML="<h2>Админ-панель</h2><h3>Пользователи</h3>";
    Object.keys(users).forEach(u=>{
        admin.innerHTML+=`
        <div class="admin-item">${u}
        ${u!=="martin_mefik"?
        `<button onclick="deleteUser('${u}')">Удалить</button>`:""}
        </div>`;
    });
    admin.innerHTML+="<h3>Видео</h3>";
    videos.forEach(v=>{
        admin.innerHTML+=`
        <div class="admin-item">@${v.user}
        <button onclick="deleteVideo(${v.id})">Удалить видео</button>
        </div>`;
    });
}

function deleteUser(u){
    delete users[u];
    videos=videos.filter(v=>v.user!==u);
    save(); showAdmin();
}
function deleteVideo(id){
    videos=videos.filter(v=>v.id!==id);
    save(); showAdmin();
}

function hideAll(){
    feed.classList.add("hidden");
    direct.classList.add("hidden");
    chat.classList.add("hidden");
    admin.classList.add("hidden");
}

if(currentUser) start();
</script>
</body>
</html>
